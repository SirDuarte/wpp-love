<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matheus + Clara</title>

  <style>
    :root{
      --bg:#0b0b10;
      --text:#f2f2ff;
      --muted:#b7b7c6;
      --accent:#ff4d8d;
      --accent2:#7c5cff;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;

      --card: rgba(255,255,255,.06);
      --card2: rgba(0,0,0,.18);
      --stroke: rgba(255,255,255,.10);

      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,77,141,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(124,92,255,.22), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .hidden{ display:none !important; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    .btn{
      cursor:pointer;
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border:0; color:white;
      padding:10px 14px; border-radius:14px;
      font-weight:900; font-size:13px;
      box-shadow: 0 14px 30px rgba(255,77,141,.16);
      transition: transform .12s ease, filter .12s ease;
      letter-spacing:.2px;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.04); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btnGhost{
      cursor:pointer;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding:10px 14px; border-radius:14px;
      font-weight:900; font-size:13px;
      transition: transform .12s ease, background .12s ease;
    }
    .btnGhost:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }

    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px; color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }

    /* ---------- Overlays ---------- */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,77,141,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(124,92,255,.18), transparent 60%),
        rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      z-index:9999;
    }
    .overlayCard{
      width:min(860px, 100%);
      border-radius:24px;
      padding:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,20,34,.88);
      box-shadow: var(--shadow);
    }

    /* ---------- Album ---------- */
    .albumWrap{ display:grid; gap:12px; }
    .albumTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .albumTitle{ display:flex; flex-direction:column; gap:4px; }
    .albumTitle h1{ margin:0; font-size:18px; }
    .albumTitle p{ margin:0; color:var(--muted); font-size:13px; }

    .frame{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .frame img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.02);
    }
    .frame::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.62));
      pointer-events:none;
    }
    .caption{
      position:absolute; left:14px; right:14px; bottom:12px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
      z-index:3;
    }
    .caption .big{
      font-size:18px; font-weight:950; letter-spacing:.2px; margin:0;
      text-shadow: 0 10px 26px rgba(0,0,0,.5);
    }
    .caption .small{
      margin:6px 0 0; color: rgba(255,255,255,.86); font-size:12px; line-height:1.35;
      text-shadow: 0 10px 26px rgba(0,0,0,.55);
    }
    .dots{ display:flex; gap:6px; justify-content:center; padding-top:2px; }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .dot:hover{ transform: scale(1.1); }
    .dot.active{ background: rgba(255,77,141,.85); border-color: rgba(255,77,141,.55); }

    .placeholder{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:2;
      padding:16px;
      text-align:center;
    }
    .placeholder .box{
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: 640px;
    }
    .placeholder .t{ margin:0; font-weight:950; font-size:16px; }
    .placeholder .s{ margin:8px 0 0; color: rgba(255,255,255,.82); font-size:12px; line-height:1.4; }

    /* ---------- PIN ---------- */
    .pinRow{ display:flex; gap:10px; align-items:center; margin-top:14px; }
    .pinInput{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      display:none;
    }

    /* ---------- App ---------- */
    header{
      padding:26px 18px 10px;
      max-width:980px;
      margin:0 auto;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
    }
    .topActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .title h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; max-width:820px;}

    main{
      max-width:980px;
      margin:0 auto;
      padding:0 18px 46px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      align-items:start;
    }

    /* üî• importante: p√°ginas viram "transparentes" pro grid */
    #page-start, #page-story{
      grid-column: 1 / -1;
      display: contents; /* faz os cards virarem itens diretos do grid */
    }

    .card{
      grid-column: 1 / -1; /* sempre 100% da largura do container */
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
      animation: pop .22s ease both;
    }
    @keyframes pop{ from{ transform: translateY(4px); opacity:.0;} to{ transform: translateY(0); opacity:1;} }

    .card h2{ margin:0 0 10px; font-size:14px; letter-spacing:.2px; }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }

    .heroBox{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: var(--card2);
      padding:14px;
    }
    .heroMsg{
      font-size:16px;
      font-weight:950;
      margin:0 0 8px;
      letter-spacing:.1px;
    }
    .heroSub{
      margin:0;
      color: rgba(255,255,255,.84);
      line-height:1.45;
    }

    /* KPIs */
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .kpi{
      display:flex; flex-direction:column; gap:6px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      min-height: 86px;
    }
    .kpi .v{ font-size:22px; font-weight:950; }
    .kpi .l{ font-size:12px; color:var(--muted); }

    /* Bars */
    .barWrap{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .barRow{
      display:grid;
      grid-template-columns: 210px 1fr 90px;
      gap:10px;
      align-items:center;
    }
    .barLabel{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .barLabel .badge{
      max-width:210px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .bar{
      height:12px; border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border-radius:999px;
      transition: width .65s cubic-bezier(.2,.9,.2,1);
    }

    .quoteBox{
      margin-top:12px;
      padding:12px 12px;
      border-left:3px solid rgba(255,77,141,.7);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
    }
    .quoteBox .meta{ color: var(--muted); font-size:12px; margin-bottom:6px;}

    /* Timeline */
    .timeline{ display:grid; gap:10px; margin-top:8px; }
    .tlItem{
      display:flex; gap:12px; align-items:flex-start;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .tlDot{
      width:12px; height:12px; margin-top:4px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      box-shadow: 0 10px 24px rgba(255,77,141,.16);
      flex: 0 0 12px;
    }
    .tlDate{ font-weight:950; letter-spacing:.2px; margin:0; }
    .tlText{
      margin:6px 0 0;
      color: rgba(255,255,255,.85);
      line-height:1.45;
      font-size:13px;
    }

    /* Emojis */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
      font-size:13px;
    }
    .chip small{ color: var(--muted); font-weight:900; font-size:12px; }

    /* Final */
    .pulse{ animation: pulse 1.4s ease-in-out infinite; }
    @keyframes pulse{ 0%{ transform: scale(1);} 50%{ transform: scale(1.015);} 100%{ transform: scale(1);} }

    .heartBig{
      font-size:72px;
      line-height:1;
      margin:0;
      text-align:center;
      filter: drop-shadow(0 16px 30px rgba(255,77,141,.18));
    }

    .lyrics{
      margin:12px auto 0;
      max-width:760px;
      text-align:center;
      line-height:1.65;
      color: rgba(255,255,255,.90);
      font-weight:700;
      white-space:pre-line;
    }

    .giftCta{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .giftTitle{
      font-weight:950;
      letter-spacing:.2px;
      font-size:14px;
      color: rgba(255,255,255,.92);
    }

    /* Responsive */
    @media(max-width:860px){
      .kpiRow{ grid-template-columns: 1fr; }
      .barRow{ grid-template-columns: 1fr; gap:8px; }
      .barLabel .badge{ max-width: 100%; }
      .topActions{ justify-content:flex-start; }
    }
  </style>
</head>

<body>

  <!-- 1) ALBUM -->
  <div class="overlay" id="albumOverlay">
    <div class="overlayCard">
      <div class="albumWrap">
        <div class="albumTop">
          <div class="albumTitle">
            <h1>üíû Matheus + Clara</h1>
            <p>Um pedacinho da nossa hist√≥ria‚Ä¶</p>
          </div>
          <span class="badge" id="albumCount">1/5</span>
        </div>

        <div class="frame">
          <img id="albumImg" alt="Foto do √°lbum" />
          <div class="placeholder hidden" id="photoPlaceholder">
            <div class="box">
              <p class="t">Foto indispon√≠vel üòÖ</p>
              <p class="s">Mas a gente sabe que ela existe. üíó</p>
            </div>
          </div>

          <div class="caption">
            <div>
              <p class="big" id="albumBig">‚Äî</p>
              <p class="small" id="albumSmall">‚Äî</p>
            </div>
            <span class="badge" id="albumTag">üíó</span>
          </div>
        </div>

        <div class="dots" id="dots"></div>

        <div class="row" style="justify-content:space-between;">
          <button class="btnGhost" id="prevBtn">‚óÄ Anterior</button>
          <button class="btn" id="nextBtn">Pr√≥ximo ‚ñ∂</button>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button class="btn" id="goPinFromAlbum">Continuar üîí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 2) PIN -->
  <div class="overlay hidden" id="pinOverlay">
    <div class="overlayCard">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="badge">üîí Acesso</div>
          <h2 style="margin:10px 0 0;">Digite a data</h2>
          <div class="muted" style="margin-top:6px;">Formato: <span class="mono">DD/MM</span></div>
        </div>
        <button class="btnGhost" id="backToAlbum">‚Üê Voltar</button>
      </div>

      <div class="pinRow">
        <input class="pinInput" id="pin" placeholder="DD/MM" inputmode="numeric" />
        <button class="btn" id="enterBtn">Entrar</button>
      </div>
      <div class="toast" id="toast">Data inv√°lida.</div>
    </div>
  </div>


  <!-- 3) APP -->
  <div id="app" class="hidden">
    <header>
      <div class="title">
        <h1>üíå Matheus + Clara</h1>
        <p>Feito com carinho, a partir da nossa conversa.</p>
      </div>
      <div class="topActions">
        <span class="badge" id="statusBadge">Carregando‚Ä¶</span>
        <button class="btnGhost" id="restartBtn">‚ü≤ Recome√ßar</button>
      </div>
    </header>

    <main>
      <div class="grid">

        <!-- PAGE 1 -->
        <div id="page-start">
          <div class="card" id="sec-start">
            <h2>O come√ßo</h2>
            <div class="heroBox">
              <p class="heroMsg" id="firstMsg">‚Äú‚Ä¶‚Äù</p>
              <p class="heroSub">Tudo come√ßou em um superlike no Inner Circle.</p>
              <div class="row" style="margin-top:12px;">
                <button class="btn" id="enterStoryBtn">Entrar na nossa hist√≥ria</button>
              </div>
            </div>
          </div>
        </div>

        <!-- PAGE 2 -->
        <div id="page-story" class="hidden">

          <div class="row" style="justify-content:flex-start;">
            <button class="btnGhost" id="backToStartBtn">‚Üê Voltar para o come√ßo</button>
          </div>

          <div class="card" id="sec-story">
            <h2>Linha do tempo</h2>
            <div class="timeline" id="timeline"></div>
          </div>

          <div class="card" id="sec-stats">
            <h2>N√∫meros que viram romance</h2>

            <div class="kpiRow" id="kpis">
              <div class="kpi"><div class="v">‚Äî</div><div class="l">Total de mensagens</div></div>
              <div class="kpi"><div class="v">‚Äî</div><div class="l">Total de dias conversando</div></div>
              <div class="kpi"><div class="v">‚Äî</div><div class="l">Hor√°rio favorito</div></div>
            </div>

            <div class="hr"></div>

            <h2 style="margin-top:0;">‚ÄúEu te amo‚Äù e varia√ß√µes</h2>
            <div class="muted">Quantas vezes cada um falou</div>
            <div class="barWrap" id="loveBars"></div>

            <div class="quoteBox">
              <div class="meta">Clara Gomes ‚Ä¢ 11/01/2026 15:42</div>
              <div>To com saudades</div>
            </div>

            <div class="quoteBox">
              <div class="meta">Matheus Duarte ‚Ä¢ 11/01/2026 19:04</div>
              <div>Vou sentir saudades</div>
            </div>

            <div class="hr"></div>

            <div class="grid" style="gap:14px;">
              <div class="card" style="margin:0; grid-column: span 12;">
                <h2>Top 10 palavras de carinho</h2>
                <div class="barWrap" id="topWords"></div>
              </div>

              <div class="card" style="margin:0; grid-column: span 12;">
                <h2>O dia mais intenso</h2>
                <div class="muted" id="bestDayInfo">‚Äî</div>
                <div class="hr"></div>
                <div class="muted" style="margin-bottom:8px;">Top 5 dias com mais mensagens</div>
                <div class="barWrap" id="topDays"></div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid" style="gap:14px;">
              <div class="card" style="margin:0; grid-column: span 12;">
                <h2>Emojis mais usados</h2>
                <div class="chips" id="emojiChips"></div>
              </div>

              <div class="card" style="margin:0; grid-column: span 12;">
                <h2>Fotos enviadas</h2>
                <div class="kpiRow" id="photoKpis"></div>
              </div>
            </div>
          </div>

          <div class="card" id="sec-faith">
            <h2>Pequenas certezas</h2>
            <div class="quoteBox">
              ‚ÄúCarregue em seu cora√ß√£o a certeza de que sempre valer√° a pena esperar. O nosso tempo tem pressa, o tempo de Deus tem perfei√ß√£o.‚Äù
            </div>
            <div class="quoteBox">
              ‚ÄúDeus, que seus planos sejam melhores que o meu.‚Äù
            </div>
          </div>

          <div class="card" id="sec-question">
            <h2>Final</h2>
            <div class="heroBox pulse">
              <p class="heroMsg" style="margin:0 0 8px;">Tenho uma pergunta‚Ä¶</p>
              <p class="heroSub" style="margin:0 0 14px;">Respira. Sorri. E olha pra gente. üíó</p>
              <button class="btn" id="openQuestionBtn">Tenho uma pergunta‚Ä¶</button>
            </div>

            <div class="heroBox hidden" id="questionBox" style="margin-top:12px;">
              <p class="heroMsg" style="margin:0 0 8px;">Quer namorar comigo?</p>
              <div class="row" style="margin-top:10px;">
                <button class="btn" id="yesBtn">SIM üíç</button>
                <button class="btn" id="obviousBtn">√ìBVIO üò≠</button>
                <button class="btnGhost" id="noBtn">N√£o</button>
              </div>
              <div class="toast" id="noToast" style="display:none; margin-top:12px;">Tenta de novo üòÑ</div>
            </div>
          </div>

          <div class="card hidden" id="sec-gift">
            <h2>‚ú®</h2>
            <div class="heroBox">
              <p class="heartBig">‚ù§Ô∏è</p>
              <div class="lyrics" id="lyricsText">
A gente se escolhe todo dia
E eu te escolheria mais milh√µes de vidas
Porque uma s√≥ √© pouco com voc√™
                E eu quero tudo que eu puder viver com voc√™
                              </div>

              <div class="giftCta">
                <div class="giftTitle">Pegue seu presente!</div>
                <button class="btn">Abrir presente üéÅ</button>
              </div>

            </div>

            <div class="row" style="margin-top:12px; justify-content:flex-end;">
              <button class="btnGhost" id="restartBtn2">‚ü≤ Recome√ßar</button>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

<script>
/*****************************************************************
 * CONFIG
 *****************************************************************/
const EXPECTED_PIN_NUMBERS = "0702"; // 07/02
const OWNER  = "SirDuarte";
const REPO   = "wpp-love";
const BRANCH = "main";

const CHAT_LOCAL_CANDIDATES = [
  "./assets/chat/_chat.txt",
  "assets/chat/_chat.txt",
  "/assets/chat/_chat.txt"
];

const CHAT_RAW = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/assets/chat/_chat.txt`;
;

// Fotos (5 imagens: 01..05)
const PHOTO_NUMBERS = ["01","02","03","04","05"];
const PHOTO_EXTS = [".jpg",".jpeg",".png",".webp"];

// Textos do √°lbum
const ALBUM_TEXT = [
  { big:"A gente",        small:"Do jeitinho que Deus escreveu.", tag:"üíó" },
  { big:"Nossa hist√≥ria", small:"Feita de detalhes, risadas e cuidado.", tag:"‚ú®" },
  { big:"Eu + voc√™",      small:"E a certeza de que vale a pena.", tag:"ü§ç" },
  { big:"Caminho",        small:"Com calma, com verdade e f√©.", tag:"üåô" },
  { big:"Futuro",         small:"O melhor de Deus ainda est√° por vir.", tag:"üåπ" }
];

/*****************************************************************
 * Album refs
 *****************************************************************/
const albumOverlay = document.getElementById("albumOverlay");
const pinOverlay   = document.getElementById("pinOverlay");
const fileOverlay  = document.getElementById("fileOverlay");

const albumImg = document.getElementById("albumImg");
const photoPlaceholder = document.getElementById("photoPlaceholder");
const albumBig = document.getElementById("albumBig");
const albumSmall = document.getElementById("albumSmall");
const albumTag = document.getElementById("albumTag");
const albumCount = document.getElementById("albumCount");
const dots = document.getElementById("dots");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const goPinFromAlbum = document.getElementById("goPinFromAlbum");

let albumIndex = 0;

function absFromHere(relPath){
  return new URL(relPath, window.location.href).toString();
}
async function fetchOk(url){
  try{
    const res = await fetch(url, { cache:"no-store" });
    return res.ok;
  }catch(e){ return false; }
}
async function findFirstWorkingUrl(urls){
  for(const u of urls){
    if(await fetchOk(u)) return u;
  }
  return null;
}
async function renderAlbum(){
  const num = PHOTO_NUMBERS[albumIndex];
  const text = ALBUM_TEXT[albumIndex] || { big:"", small:"", tag:"üíó" };

  albumBig.textContent = text.big;
  albumSmall.textContent = text.small;
  albumTag.textContent = text.tag || "üíó";
  albumCount.textContent = `${albumIndex+1}/${PHOTO_NUMBERS.length}`;

  prevBtn.disabled = albumIndex === 0;
  renderDots();

  photoPlaceholder.classList.add("hidden");
  albumImg.removeAttribute("src");

  const candidates = [];
  for(const ext of PHOTO_EXTS) candidates.push(absFromHere(`./assets/photos/${num}${ext}`));

  const okUrl = await findFirstWorkingUrl(candidates);
  if(okUrl){
    albumImg.src = okUrl;
  } else {
    photoPlaceholder.classList.remove("hidden");
  }
}
function renderDots(){
  dots.innerHTML = "";
  for(let i=0;i<PHOTO_NUMBERS.length;i++){
    const d = document.createElement("div");
    d.className = "dot" + (i===albumIndex ? " active" : "");
    d.onclick = async ()=>{ albumIndex=i; await renderAlbum(); };
    dots.appendChild(d);
  }
}
prevBtn.onclick = async ()=>{ albumIndex = Math.max(0, albumIndex-1); await renderAlbum(); };
nextBtn.onclick = async ()=>{ albumIndex = Math.min(PHOTO_NUMBERS.length-1, albumIndex+1); await renderAlbum(); };

goPinFromAlbum.onclick = ()=>{
  albumOverlay.classList.add("hidden");
  pinOverlay.classList.remove("hidden");
  document.getElementById("pin").focus();
};
renderAlbum();

/*****************************************************************
 * PIN
 *****************************************************************/
const pin = document.getElementById("pin");
const enterBtn = document.getElementById("enterBtn");
const toast = document.getElementById("toast");
const backToAlbum = document.getElementById("backToAlbum");

function normPinDigits(s){ return (s||"").replace(/\D/g,""); }

function openAlbum(){
  pinOverlay.classList.add("hidden");
  albumOverlay.classList.remove("hidden");
}
backToAlbum.onclick = openAlbum;

function tryEnter(){
  const digits = normPinDigits(pin.value);
  if(digits === EXPECTED_PIN_NUMBERS){
    toast.style.display = "none";
    pinOverlay.classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    loadAndRender();
    showPageStart();
  } else {
    toast.style.display = "block";
    toast.textContent = "Data inv√°lida.";
  }
}
enterBtn.onclick = tryEnter;
pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryEnter(); });

/*****************************************************************
 * P√ÅGINAS
 *****************************************************************/
const pageStart = document.getElementById("page-start");
const pageStory = document.getElementById("page-story");
const enterStoryBtn = document.getElementById("enterStoryBtn");
const backToStartBtn = document.getElementById("backToStartBtn");

function showPageStart(){
  pageStory.classList.add("hidden");
  pageStart.classList.remove("hidden");
  window.scrollTo({ top:0, behavior:"instant" });
}
function showPageStory(){
  pageStart.classList.add("hidden");
  pageStory.classList.remove("hidden");
  window.scrollTo({ top:0, behavior:"instant" });
}

enterStoryBtn.onclick = ()=> showPageStory();
backToStartBtn.onclick = ()=> showPageStart();

/*****************************************************************
 * RECOME√áAR
 *****************************************************************/
const restartBtn  = document.getElementById("restartBtn");
const restartBtn2 = document.getElementById("restartBtn2");

function fullRestart(){
  document.getElementById("app").classList.add("hidden");
  pinOverlay.classList.add("hidden");
  albumOverlay.classList.remove("hidden");
  albumIndex = 0;
  renderAlbum();
  window.scrollTo({ top:0, behavior:"instant" });
}
restartBtn.onclick = fullRestart;
restartBtn2.onclick = fullRestart;

/*****************************************************************
 * Load Chat
 *****************************************************************/
const statusBadge = document.getElementById("statusBadge");

async function loadAndRender(){
  statusBadge.textContent = "Carregando‚Ä¶";
  let text = null;

  // 1) tenta LOCAL
  for(const path of CHAT_LOCAL_CANDIDATES){
    try{
      const res = await fetch(absFromHere(path), { cache:"no-store" });
      if(res.ok){
        text = await res.text();
        break;
      }
    }catch(e){}
  }

  // 2) se falhar, tenta RAW do GitHub
  if(!text){
    try{
      const res = await fetch(CHAT_RAW, { cache:"no-store" });
      if(res.ok) text = await res.text();
    }catch(e){}
  }

  // 3) se ainda falhar, s√≥ mostra erro (sem file picker)
  if(!text){
    statusBadge.textContent = "Falha ao carregar";
    alert("N√£o consegui carregar assets/chat/_chat.txt. Confirme se o arquivo est√° commitado no GitHub em assets/chat/_chat.txt");
    return;
  }

  finishWithText(text);
}

function finishWithText(text){
  const messages = parseWhatsApp(text);
  if(!messages.length){
    statusBadge.textContent = "Sem dados";
    return;
  }
  statusBadge.textContent = "Pronto üíó";
  renderAll(messages);
}

/*****************************************************************
 * Parser WhatsApp
 *****************************************************************/
const lineStartRe = /^\[(\d{2}\/\d{2}\/\d{4}),\s(\d{2}:\d{2}:\d{2})\]\s([^:]+):\s(.*)$/;

function parseWhatsApp(text){
  const lines = (text || "").replace(/\r\n/g, "\n").split("\n");
  const out = [];
  let cur = null;

  for(const raw of lines){
    const line = raw ?? "";
    const m = line.match(lineStartRe);
    if(m){
      if(cur) out.push(cur);
      const [_, dateStr, timeStr, author, msg] = m;
      cur = {
        dt: parseBRDateTime(dateStr, timeStr),
        author: author.trim(),
        text: (msg || "").trim()
      };
    } else {
      if(cur){
        cur.text += (cur.text ? "\n" : "") + line.trimEnd();
      }
    }
  }
  if(cur) out.push(cur);
  return out.filter(x => x.author && x.dt && typeof x.text === "string");
}

function parseBRDateTime(d, t){
  const [dd, mm, yyyy] = d.split("/").map(Number);
  const [HH, MM, SS] = t.split(":").map(Number);
  return new Date(yyyy, mm-1, dd, HH, MM, SS);
}

/*****************************************************************
 * RENDER PRINCIPAL (simples)
 *****************************************************************/
function renderAll(messages){
  const first = messages[0];
  document.getElementById("firstMsg").textContent =
    first ? `‚Äú${first.text.slice(0,120)}‚Äù` : "‚ÄúOi‚Ä¶‚Äù";
}
</script>
</body>
</html>

