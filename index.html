<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matheus + Clara</title>

  <style>
    :root{
      --bg:#0b0b10;
      --text:#f2f2ff;
      --muted:#b7b7c6;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;

      --card: rgba(255,255,255,.06);
      --card2: rgba(0,0,0,.18);
      --stroke: rgba(255,255,255,.10);

      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,77,141,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(124,92,255,.22), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .hidden{ display:none !important; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    .btn{
      cursor:pointer;
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border:0; color:white;
      padding:10px 14px; border-radius:14px;
      font-weight:900; font-size:13px;
      box-shadow: 0 14px 30px rgba(255,77,141,.16);
      transition: transform .12s ease, filter .12s ease;
      letter-spacing:.2px;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.04); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btnGhost{
      cursor:pointer;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding:10px 14px; border-radius:14px;
      font-weight:900; font-size:13px;
      transition: transform .12s ease, background .12s ease;
    }
    .btnGhost:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }

    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px; color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }

    /* ---------- Overlays ---------- */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,77,141,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(124,92,255,.18), transparent 60%),
        rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      z-index:9999;
    }
    .overlayCard{
      width:min(860px, 100%);
      border-radius:24px;
      padding:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,20,34,.88);
      box-shadow: var(--shadow);
    }

    /* ---------- Album ---------- */
    .albumWrap{ display:grid; gap:12px; }
    .albumTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .albumTitle{ display:flex; flex-direction:column; gap:4px; }
    .albumTitle h1{ margin:0; font-size:18px; }
    .albumTitle p{ margin:0; color:var(--muted); font-size:13px; }

    .frame{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .frame img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.02);
    }
    .frame::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.62));
      pointer-events:none;
    }
    .caption{
      position:absolute; left:14px; right:14px; bottom:12px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
      z-index:3;
    }
    .caption .big{
      font-size:18px; font-weight:950; letter-spacing:.2px; margin:0;
      text-shadow: 0 10px 26px rgba(0,0,0,.5);
    }
    .caption .small{
      margin:6px 0 0; color: rgba(255,255,255,.86); font-size:12px; line-height:1.35;
      text-shadow: 0 10px 26px rgba(0,0,0,.55);
    }
    .dots{ display:flex; gap:6px; justify-content:center; padding-top:2px; }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .dot:hover{ transform: scale(1.1); }
    .dot.active{ background: rgba(255,77,141,.85); border-color: rgba(255,77,141,.55); }

    .placeholder{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:2;
      padding:16px;
      text-align:center;
    }
    .placeholder .box{
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: 640px;
    }
    .placeholder .t{ margin:0; font-weight:950; font-size:16px; }
    .placeholder .s{ margin:8px 0 0; color: rgba(255,255,255,.82); font-size:12px; line-height:1.4; }

    /* ---------- PIN ---------- */
    .pinRow{ display:flex; gap:10px; align-items:center; margin-top:14px; }
    .pinInput{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      display:none;
    }

    /* ---------- App ---------- */
    #app{ width:100%; }
    header{
      padding:26px 18px 10px;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      max-width:980px;
      margin:0 auto;
    }
    .topActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .title h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; max-width:820px;}

    /* ‚úÖ garante centraliza√ß√£o mesmo em telas ultra-wide */
    main{
      width:100%;
      display:flex;
      justify-content:center;
      padding:0 18px 46px;
    }
    .container{
      width:100%;
      max-width:980px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      align-items:start;
    }

    #page-start, #page-story{
      grid-column: 1 / -1;
      display: contents;
    }

    .card{
      grid-column: 1 / -1;
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
      animation: pop .22s ease both;
    }
    @keyframes pop{ from{ transform: translateY(4px); opacity:.0;} to{ transform: translateY(0); opacity:1;} }

    .card h2{ margin:0 0 10px; font-size:14px; letter-spacing:.2px; }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }

    .heroBox{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: var(--card2);
      padding:14px;
    }
    .heroMsg{
      font-size:16px;
      font-weight:950;
      margin:0 0 8px;
      letter-spacing:.1px;
    }
    .heroSub{
      margin:0;
      color: rgba(255,255,255,.84);
      line-height:1.45;
    }

    /* KPIs */
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .kpi{
      display:flex; flex-direction:column; gap:6px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      min-height: 86px;
    }
    .kpi .v{ font-size:22px; font-weight:950; }
    .kpi .l{ font-size:12px; color:var(--muted); }

    /* Bars */
    .barWrap{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .barRow{
      display:grid;
      grid-template-columns: 210px 1fr 90px;
      gap:10px;
      align-items:center;
    }
    .barLabel{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .barLabel .badge{
      max-width:210px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .bar{
      height:12px; border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border-radius:999px;
      transition: width .65s cubic-bezier(.2,.9,.2,1);
    }

    .quoteBox{
      margin-top:12px;
      padding:12px 12px;
      border-left:3px solid rgba(255,77,141,.7);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
    }
    .quoteBox .meta{ color: var(--muted); font-size:12px; margin-bottom:6px;}

    /* Timeline */
    .timeline{ display:grid; gap:10px; margin-top:8px; }
    .tlItem{
      display:flex; gap:12px; align-items:flex-start;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .tlDot{
      width:12px; height:12px; margin-top:4px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      box-shadow: 0 10px 24px rgba(255,77,141,.16);
      flex: 0 0 12px;
    }
    .tlDate{ font-weight:950; letter-spacing:.2px; margin:0; }
    .tlText{
      margin:6px 0 0;
      color: rgba(255,255,255,.85);
      line-height:1.45;
      font-size:13px;
    }

    /* Emojis */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
      font-size:13px;
    }
    .chip small{ color: var(--muted); font-weight:900; font-size:12px; }

    /* Final */
    .pulse{ animation: pulse 1.4s ease-in-out infinite; }
    @keyframes pulse{ 0%{ transform: scale(1);} 50%{ transform: scale(1.015);} 100%{ transform: scale(1);} }

    .heartBig{
      font-size:72px;
      line-height:1;
      margin:0;
      text-align:center;
      filter: drop-shadow(0 16px 30px rgba(255,77,141,.18));
    }

    .lyrics{
      margin:12px auto 0;
      max-width:760px;
      text-align:center;
      line-height:1.65;
      color: rgba(255,255,255,.90);
      font-weight:700;
      white-space:pre-line;
    }

    /* Responsive */
    @media(max-width:860px){
      .kpiRow{ grid-template-columns: 1fr; }
      .barRow{ grid-template-columns: 1fr; gap:8px; }
      .barLabel .badge{ max-width: 100%; }
      .topActions{ justify-content:flex-start; }
    }
  </style>
</head>

<body>

  <!-- 1) ALBUM (sempre a primeira tela) -->
  <div class="overlay" id="albumOverlay">
    <div class="overlayCard">
      <div class="albumWrap">
        <div class="albumTop">
          <div class="albumTitle">
            <h1>üíû Matheus + Clara</h1>
            <p>Um pedacinho da nossa hist√≥ria‚Ä¶</p>
          </div>
          <span class="badge" id="albumCount">1/5</span>
        </div>

        <div class="frame">
          <img id="albumImg" alt="Foto do √°lbum" />
          <div class="placeholder hidden" id="photoPlaceholder">
            <div class="box">
              <p class="t">Foto indispon√≠vel üòÖ</p>
              <p class="s">Confere se tem <span class="mono">assets/photos/01..05</span> no repo.</p>
            </div>
          </div>

          <div class="caption">
            <div>
              <p class="big" id="albumBig">‚Äî</p>
              <p class="small" id="albumSmall">‚Äî</p>
            </div>
            <span class="badge" id="albumTag">üíó</span>
          </div>
        </div>

        <div class="dots" id="dots"></div>

        <div class="row" style="justify-content:space-between;">
          <button class="btnGhost" id="prevBtn">‚óÄ Anterior</button>
          <button class="btn" id="nextBtn">Pr√≥ximo ‚ñ∂</button>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button class="btn" id="goPinFromAlbum">Continuar üîí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 2) PIN -->
  <div class="overlay hidden" id="pinOverlay">
    <div class="overlayCard">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="badge">üîí Acesso</div>
          <h2 style="margin:10px 0 0;">Digite a data</h2>
          <div class="muted" style="margin-top:6px;">Formato: <span class="mono">DD/MM</span></div>
        </div>
        <button class="btnGhost" id="backToAlbum">‚Üê Voltar</button>
      </div>

      <div class="pinRow">
        <input class="pinInput" id="pin" placeholder="DD/MM" inputmode="numeric" />
        <button class="btn" id="enterBtn">Entrar</button>
      </div>
      <div class="toast" id="toast">Data inv√°lida.</div>
    </div>
  </div>

  <!-- 3) APP -->
  <div id="app" class="hidden">
    <header>
      <div class="title">
        <h1>üíå Matheus + Clara</h1>
        <p>Feito com carinho, a partir da nossa conversa.</p>
      </div>
      <div class="topActions">
        <span class="badge" id="statusBadge">Carregando‚Ä¶</span>
        <button class="btnGhost" id="restartBtn">‚ü≤ Recome√ßar</button>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="grid">

          <!-- PAGE 1 (p√≥s-PIN) -->
          <div id="page-start">
            <div class="card" id="sec-start">
              <h2>O come√ßo</h2>
              <div class="heroBox">
                <p class="heroMsg" id="firstMsg">‚Äú‚Ä¶‚Äù</p>
                <p class="heroSub">Tudo come√ßou em um superlike no Inner Circle.</p>
                <div class="row" style="margin-top:12px;">
                  <button class="btn" id="enterStoryBtn">Entrar na nossa hist√≥ria</button>
                </div>

                <div class="toast" id="loadFailToast" style="display:none; margin-top:12px;">
                  N√£o consegui carregar o <span class="mono">assets/chat/_chat.txt</span>. Confere se ele est√° commitado no repo.
                </div>
              </div>
            </div>
          </div>

          <!-- PAGE 2 -->
          <div id="page-story" class="hidden">

            <div class="row" style="justify-content:flex-start;">
              <button class="btnGhost" id="backToStartBtn">‚Üê Voltar para o come√ßo</button>
            </div>

            <div class="card" id="sec-story">
              <h2>Linha do tempo</h2>
              <div class="timeline" id="timeline"></div>
            </div>

            <div class="card" id="sec-stats">
              <h2>N√∫meros que viram romance</h2>

              <div class="kpiRow" id="kpis">
                <div class="kpi"><div class="v">‚Äî</div><div class="l">Total de mensagens</div></div>
                <div class="kpi"><div class="v">‚Äî</div><div class="l">Total de dias conversando</div></div>
                <div class="kpi"><div class="v">‚Äî</div><div class="l">Hor√°rio favorito</div></div>
              </div>

              <div class="hr"></div>

              <h2 style="margin-top:0;">‚ÄúEu te amo‚Äù e varia√ß√µes</h2>
              <div class="muted">Quantas vezes cada um falou</div>
              <div class="barWrap" id="loveBars"></div>

              <div class="hr"></div>

              <h2 style="margin-top:0;">Saudades que marcaram</h2>
              <div class="muted">S√≥ duas mensagens (as espec√≠ficas que voc√™ escolheu)</div>
              <div id="saudadeFixed"></div>

              <div class="hr"></div>

              <div class="grid" style="gap:14px;">
                <div class="card" style="margin:0; grid-column: span 12;">
                  <h2>Top 10 palavras de carinho</h2>
                  <div class="barWrap" id="topWords"></div>
                </div>

                <div class="card" style="margin:0; grid-column: span 12;">
                  <h2>O dia mais intenso</h2>
                  <div class="muted" id="bestDayInfo">‚Äî</div>
                  <div class="hr"></div>
                  <div class="muted" style="margin-bottom:8px;">Top 5 dias com mais mensagens</div>
                  <div class="barWrap" id="topDays"></div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="grid" style="gap:14px;">
                <div class="card" style="margin:0; grid-column: span 12;">
                  <h2>Emojis mais usados</h2>
                  <div class="chips" id="emojiChips"></div>
                </div>

                <div class="card" style="margin:0; grid-column: span 12;">
                  <h2>Fotos enviadas</h2>
                  <div class="kpiRow" id="photoKpis"></div>
                </div>
              </div>
            </div>

            <div class="card" id="sec-faith">
              <h2>Pequenas certezas</h2>
              <div class="quoteBox">
                ‚ÄúCarregue em seu cora√ß√£o a certeza de que sempre valer√° a pena esperar. O nosso tempo tem pressa, o tempo de Deus tem perfei√ß√£o.‚Äù
              </div>
              <div class="quoteBox">
                ‚ÄúDeus, que seus planos sejam melhores que o meu.‚Äù
              </div>
            </div>

            <div class="card" id="sec-question">
              <h2>Final</h2>
              <div class="heroBox pulse">
                <p class="heroMsg" style="margin:0 0 8px;">Tenho uma pergunta‚Ä¶</p>
                <p class="heroSub" style="margin:0 0 14px;">Respira. Sorri. E olha pra gente. üíó</p>
                <button class="btn" id="openQuestionBtn">Tenho uma pergunta‚Ä¶</button>
              </div>

              <div class="heroBox hidden" id="questionBox" style="margin-top:12px;">
                <p class="heroMsg" style="margin:0 0 8px;">Quer namorar comigo?</p>
                <div class="row" style="margin-top:10px;">
                  <button class="btn" id="yesBtn">SIM üíç</button>
                  <button class="btn" id="obviousBtn">√ìBVIO üò≠</button>
                  <button class="btnGhost" id="noBtn">N√£o</button>
                </div>
                <div class="toast" id="noToast" style="display:none; margin-top:12px;">Tenta de novo üòÑ</div>
              </div>
            </div>

            <!-- ‚úÖ PRESENTE (sem ‚ÄúAbra seu presente‚Äù) -->
            <div class="card hidden" id="sec-gift">
              <h2>‚ú®</h2>
              <div class="heroBox">
                <p class="heartBig">‚ù§Ô∏è</p>
                <div class="lyrics" id="lyricsText"></div>
              </div>

              <div class="row" style="margin-top:12px; justify-content:flex-end;">
                <button class="btnGhost" id="restartBtn2">‚ü≤ Recome√ßar</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </main>
  </div>

<script>
/*****************************************************************
 * CONFIG
 *****************************************************************/
const OWNER  = "SirDuarte";
const REPO   = "wpp-love";
const BRANCH = "main";

// PIN (07/02)
const EXPECTED_PIN_NUMBERS = "0702";

// ‚úÖ Letra (placeholder ‚Äî voc√™ cola do seu jeito, sem eu quebrar)
const LYRICS_TEXT = `COLE AQUI A LETRA DO JEITO QUE VOC√ä QUISER
(sem eu quebrar linhas automaticamente)`;

// Timeline fixa (mantive a sua)
const STORY = [
  { date:"29/12/2025", title:"Match", text:"Aquele superlike que virou destino. ‚ú®" },
  { date:"09/01/2026", title:"Primeiro encontro", text:"Quando o nervosismo virou sorriso f√°cil. ü•∞" },
  { date:"17/01/2026", title:"Segundo encontro", text:"A gente j√° parecia se conhecer h√° tempos. ü§ç" },
  { date:"20/01/2026", title:"Terceiro encontro", text:"Mais assunto, mais conex√£o, mais ‚Äòa gente‚Äô. üí¨" },
  { date:"24/01/2026", title:"Quarto encontro", text:"Ficou claro: vale a pena cuidar do que √© raro. üåπ" },
  { date:"25/01/2026", title:"Sexto encontro", text:"Nem tudo precisa de pressa ‚Äî s√≥ de verdade. üåô" },
  { date:"31/01/2026", title:"S√©timo encontro", text:"A paz de estar no lugar certo, com a pessoa certa. ‚ú®" },
  { date:"07/02/2026", title:"???", text:"Hoje eu vou te fazer uma pergunta‚Ä¶ ‚ùì‚ùì‚ùì" }
];

/*****************************************************************
 * Album config
 *****************************************************************/
const PHOTO_NUMBERS = ["01","02","03","04","05"];
const PHOTO_EXTS = [".jpg",".jpeg",".png",".webp"];
const ALBUM_TEXT = [
  { big:"A gente",        small:"Do jeitinho que Deus escreveu.", tag:"üíó" },
  { big:"Nossa hist√≥ria", small:"Feita de detalhes, risadas e cuidado.", tag:"‚ú®" },
  { big:"Eu + voc√™",      small:"E a certeza de que vale a pena.", tag:"ü§ç" },
  { big:"Caminho",        small:"Com calma, com verdade e f√©.", tag:"üåô" },
  { big:"Futuro",         small:"O melhor de Deus ainda est√° por vir.", tag:"üåπ" }
];

/*****************************************************************
 * DOM refs
 *****************************************************************/
const albumOverlay = document.getElementById("albumOverlay");
const pinOverlay   = document.getElementById("pinOverlay");

const albumImg = document.getElementById("albumImg");
const photoPlaceholder = document.getElementById("photoPlaceholder");
const albumBig = document.getElementById("albumBig");
const albumSmall = document.getElementById("albumSmall");
const albumTag = document.getElementById("albumTag");
const albumCount = document.getElementById("albumCount");
const dots = document.getElementById("dots");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const goPinFromAlbum = document.getElementById("goPinFromAlbum");

const pin = document.getElementById("pin");
const enterBtn = document.getElementById("enterBtn");
const toast = document.getElementById("toast");
const backToAlbum = document.getElementById("backToAlbum");

const pageStart = document.getElementById("page-start");
const pageStory = document.getElementById("page-story");
const enterStoryBtn = document.getElementById("enterStoryBtn");
const backToStartBtn = document.getElementById("backToStartBtn");

const restartBtn  = document.getElementById("restartBtn");
const restartBtn2 = document.getElementById("restartBtn2");

const statusBadge = document.getElementById("statusBadge");
const loadFailToast = document.getElementById("loadFailToast");

/*****************************************************************
 * Helpers de URL + fetch robusto
 *****************************************************************/
function absFromHere(relPath){
  return new URL(relPath, window.location.href).toString();
}
function withBust(url){
  const u = new URL(url);
  u.searchParams.set("v", Date.now().toString(36));
  return u.toString();
}
function rawChatUrl(){
  return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/assets/chat/_chat.txt`;
}
function jsdelivrChatUrl(){
  return `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@${BRANCH}/assets/chat/_chat.txt`;
}

async function fetchTextWithTimeout(url, ms=9000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), ms);
  try{
    const res = await fetch(withBust(url), {
      cache:"no-store",
      signal: controller.signal,
      headers: { "Cache-Control":"no-cache" }
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    return await res.text();
  } finally {
    clearTimeout(id);
  }
}

async function tryLoadChatRobust(){
  // ‚úÖ tenta caminhos locais primeiro (GitHub Pages √†s vezes resolve melhor assim)
  const localCandidates = [
    absFromHere("./assets/chat/_chat.txt"),
    absFromHere("assets/chat/_chat.txt"),
    absFromHere("/assets/chat/_chat.txt")
  ];

  // ‚úÖ depois CDN/RAW (melhor pra ‚Äúgarantir‚Äù)
  const remoteCandidates = [
    jsdelivrChatUrl(),
    rawChatUrl()
  ];

  const all = [...localCandidates, ...remoteCandidates];

  // ‚úÖ retries progressivo (ajuda quando o GH Pages ‚Äúacorda‚Äù)
  const attempts = 2;
  for(let round=1; round<=attempts; round++){
    for(const url of all){
      try{
        const text = await fetchTextWithTimeout(url, round === 1 ? 8000 : 12000);
        if(text && text.trim().length > 50) return text;
      }catch(e){}
    }
    await new Promise(r=>setTimeout(r, 450 * round));
  }

  return null;
}

/*****************************************************************
 * Album render
 *****************************************************************/
let albumIndex = 0;

async function fetchOk(url){
  try{
    const res = await fetch(withBust(url), { cache:"no-store" });
    return res.ok;
  }catch(e){ return false; }
}
async function findFirstWorkingUrl(urls){
  for(const u of urls){
    if(await fetchOk(u)) return u;
  }
  return null;
}
function renderDots(){
  dots.innerHTML = "";
  for(let i=0;i<PHOTO_NUMBERS.length;i++){
    const d = document.createElement("div");
    d.className = "dot" + (i===albumIndex ? " active" : "");
    d.onclick = async ()=>{ albumIndex=i; await renderAlbum(); };
    dots.appendChild(d);
  }
}
async function renderAlbum(){
  const num = PHOTO_NUMBERS[albumIndex];
  const text = ALBUM_TEXT[albumIndex] || { big:"", small:"", tag:"üíó" };

  albumBig.textContent = text.big;
  albumSmall.textContent = text.small;
  albumTag.textContent = text.tag || "üíó";
  albumCount.textContent = `${albumIndex+1}/${PHOTO_NUMBERS.length}`;

  prevBtn.disabled = albumIndex === 0;
  renderDots();

  photoPlaceholder.classList.add("hidden");
  albumImg.removeAttribute("src");

  const candidates = [];
  for(const ext of PHOTO_EXTS) candidates.push(absFromHere(`./assets/photos/${num}${ext}`));

  const okUrl = await findFirstWorkingUrl(candidates);
  if(okUrl){
    albumImg.src = okUrl;
  } else {
    photoPlaceholder.classList.remove("hidden");
  }
}

prevBtn.onclick = async ()=>{ albumIndex = Math.max(0, albumIndex-1); await renderAlbum(); };
nextBtn.onclick = async ()=>{ albumIndex = Math.min(PHOTO_NUMBERS.length-1, albumIndex+1); await renderAlbum(); };

goPinFromAlbum.onclick = ()=>{
  albumOverlay.classList.add("hidden");
  pinOverlay.classList.remove("hidden");
  pin.focus();
};

renderAlbum();

/*****************************************************************
 * PIN
 *****************************************************************/
function normPinDigits(s){ return (s||"").replace(/\D/g,""); }

function openAlbum(){
  pinOverlay.classList.add("hidden");
  albumOverlay.classList.remove("hidden");
}

backToAlbum.onclick = openAlbum;

async function tryEnter(){
  const digits = normPinDigits(pin.value);

  if(digits !== EXPECTED_PIN_NUMBERS){
    toast.style.display = "block";
    toast.textContent = "Data inv√°lida.";
    return;
  }

  toast.style.display = "none";
  pinOverlay.classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  showPageStart();

  // carrega chat
  statusBadge.textContent = "Carregando‚Ä¶";
  loadFailToast.style.display = "none";

  const text = await tryLoadChatRobust();
  if(!text){
    statusBadge.textContent = "Sem acesso ao arquivo";
    loadFailToast.style.display = "block";
    // ainda assim deixa o app funcionando visualmente
    return;
  }

  const messages = parseWhatsApp(text).filter(m => !isSystemMessage(m.text));
  if(!messages.length){
    statusBadge.textContent = "Sem dados";
    loadFailToast.style.display = "block";
    return;
  }

  const messages = parseWhatsApp(text).filter(m => !isSystemMessage(m.text));
console.log("Mensagens lidas:", messages.length, messages[0]); // s√≥ pra voc√™ validar no console
renderAll(messages);
 }

  statusBadge.textContent = "Pronto üíó";
  renderAll(messages);
}

enterBtn.onclick = tryEnter;
pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryEnter(); });

/*****************************************************************
 * P√ÅGINAS
 *****************************************************************/
function showPageStart(){
  pageStory.classList.add("hidden");
  pageStart.classList.remove("hidden");
  window.scrollTo({ top:0, behavior:"instant" });
}
function showPageStory(){
  pageStart.classList.add("hidden");
  pageStory.classList.remove("hidden");
  window.scrollTo({ top:0, behavior:"instant" });
}
enterStoryBtn.onclick = ()=> showPageStory();
backToStartBtn.onclick = ()=> showPageStart();

/*****************************************************************
 * RECOME√áAR (sempre volta pro √°lbum)
 *****************************************************************/
function fullRestart(){
  document.getElementById("app").classList.add("hidden");
  pinOverlay.classList.add("hidden");
  albumOverlay.classList.remove("hidden");
  albumIndex = 0;
  renderAlbum();
  pin.value = "";
  toast.style.display = "none";
  window.scrollTo({ top:0, behavior:"instant" });

  // fecha gift se aberto
  document.getElementById("sec-gift").classList.add("hidden");
  document.getElementById("questionBox").classList.add("hidden");
}
restartBtn.onclick = fullRestart;
restartBtn2.onclick = fullRestart;

/*****************************************************************
 * Timeline render
 *****************************************************************/
function renderTimeline(){
  const el = document.getElementById("timeline");
  el.innerHTML = "";
  STORY.forEach(item=>{
    const div = document.createElement("div");
    div.className = "tlItem";
    div.innerHTML = `
      <div class="tlDot"></div>
      <div>
        <p class="tlDate">${escapeHtml(item.date)} ‚Äî ${escapeHtml(item.title)}</p>
        <p class="tlText">${escapeHtml(item.text)}</p>
      </div>
    `;
    el.appendChild(div);
  });
}
renderTimeline();

/*****************************************************************
 * Parser WhatsApp (MULTI-FORMATO) ‚Äî estilo chat.js
 *****************************************************************/

// 1) Formato com colchetes e segundos:
// [11/01/2026, 15:42:07] Clara Gomes: texto
const reBracketSeconds = /^\s*(?:\u200E|\u200F|\u202A-\u202E)?\[(\d{2}\/\d{2}\/\d{4}),\s(\d{2}:\d{2}:\d{2})\]\s([^:]+):\s(.*)$/;

// 2) Formato com colchetes e sem segundos:
// [11/01/2026, 15:42] Clara Gomes: texto
const reBracketNoSeconds = /^\s*(?:\u200E|\u200F|\u202A-\u202E)?\[(\d{2}\/\d{2}\/\d{4}),\s(\d{2}:\d{2})\]\s([^:]+):\s(.*)$/;

// 3) Formato sem colchetes (muito comum no export):
// 11/01/2026 15:42 - Clara Gomes: texto
// 11/01/2026 15:42:07 - Clara Gomes: texto
const reDash = /^\s*(?:\u200E|\u200F|\u202A-\u202E)?(\d{2}\/\d{2}\/\d{4})\s(\d{2}:\d{2})(?::(\d{2}))?\s-\s([^:]+):\s(.*)$/;

function parseWhatsApp(text){
  const lines = (text || "").replace(/\r\n/g, "\n").split("\n");
  const out = [];
  let cur = null;

  for(const raw of lines){
    const line = raw ?? "";

    let m = line.match(reBracketSeconds);
    if(m){
      if(cur) out.push(cur);
      const [_, dateStr, timeStr, author, msg] = m;
      cur = { dt: parseBRDateTime(dateStr, timeStr), author: norm(author), text: (msg||"").trim() };
      continue;
    }

    m = line.match(reBracketNoSeconds);
    if(m){
      if(cur) out.push(cur);
      const [_, dateStr, timeStr, author, msg] = m;
      cur = { dt: parseBRDateTime(dateStr, timeStr + ":00"), author: norm(author), text: (msg||"").trim() };
      continue;
    }

    m = line.match(reDash);
    if(m){
      if(cur) out.push(cur);
      const [_, dateStr, hhmm, ss, author, msg] = m;
      const timeStr = `${hhmm}:${ss ? ss : "00"}`;
      cur = { dt: parseBRDateTime(dateStr, timeStr), author: norm(author), text: (msg||"").trim() };
      continue;
    }

    // Continua√ß√£o de mensagem multi-linha
    if(cur){
      cur.text += (cur.text ? "\n" : "") + line.trimEnd();
    }
  }

  if(cur) out.push(cur);

  // Remove ‚Äúmensagens de sistema‚Äù e entradas inv√°lidas
  return out
    .filter(x => x.author && x.dt instanceof Date && !Number.isNaN(x.dt.getTime()))
    .filter(x => typeof x.text === "string");
}

function parseBRDateTime(d, t){
  const [dd, mm, yyyy] = d.split("/").map(Number);
  const [HH, MM, SS] = t.split(":").map(Number);
  return new Date(yyyy, mm-1, dd, HH, MM, SS || 0);
}

function norm(s){
  return String(s ?? "").replace(/[\u200E\u200F\u202A-\u202E]/g,"").trim();
}

function isSystemMessage(text){
  const s = norm(text).toLowerCase();
  return (
    s.includes("criptografia de ponta a ponta") ||
    s.includes("mensagens e liga√ß√µes s√£o protegidas") ||
    s.includes("omitiu") && (s.includes("imagem") || s.includes("v√≠deo") || s.includes("audio") || s.includes("√°udio")) ||
    s.startsWith("‚Äé")
  );
}

/*****************************************************************
 * Detec√ß√µes / m√©tricas
 *****************************************************************/
const lovePatterns = [
  /\beu\s*te\s*amo+\b/i,
  /\bte\s*amo+\b/i,
  /\bt\s*amo+\b/i,
  /\bamo\s*(voc√™|voce|vc|tu)\b/i,
  /\bte\s*adoro+\b/i,
  /\bsou\s*apaixonad[oa]\b/i
];

function isLove(text){
  const s = (text || "").trim();
  return !!s && lovePatterns.some(re => re.test(s));
}

// stopwords simples PT
const STOP = new Set([
  "a","o","os","as","de","do","da","dos","das","e","√©","em","um","uma","pra","pro","por","na","no","nas","nos",
  "que","eu","vc","vcs","voc√™","voce","tu","me","te","se","n√£o","nao","sim","com","para","tb","tamb√©m","tambem",
  "t√°","ta","to","t√¥","tudo","bem","bom","boa","oi","ola","ol√°","kk","kkkk","haha","hahaha","pq","porque","q","d",
  "j√°","ja","mais","muito","muita","muitas","muitos","s√≥","so","vai","vou","foi","ser","tava","tive","tem","t√™m"
]);

const CARINHO_WHITELIST = new Set([
  "saudade","amor","vida","linda","lindo","meu","minha","princesa","nen√©m","nenem","bb","beb√™","bebe","gatinha","gatinho",
  "querida","querido","moz√£o","mozao","cora√ß√£o","coracao","beijo","beijinho","abra√ßo","abraco"
]);

function isPhotoMessage(text){
  const s = norm(text).toLowerCase();
  return s.includes("imagem ocultada") || s.includes("imagem omitida") || s.includes("image omitted");
}

// Emoji regex (bom o suficiente pra uso geral)
const emojiRe = /[\p{Extended_Pictographic}]/gu;

function extractEmojis(text){
  const s = text || "";
  const m = s.match(emojiRe);
  return m ? m : [];
}

function computeTopWords(messages){
  const counts = new Map();

  for(const m of messages){
    const text = norm(m.text)
      .toLowerCase()
      .replace(/[^\p{L}\p{N}\s]/gu, " ")
      .replace(/\s+/g, " ")
      .trim();

    if(!text) continue;

    const words = text.split(" ").filter(Boolean);
    for(const w0 of words){
      const w = w0.normalize("NFD").replace(/\p{Diacritic}/gu,"");
      if(w.length < 3) continue;
      if(STOP.has(w)) continue;
      counts.set(w, (counts.get(w) || 0) + 1);
    }
  }

  const arr = Array.from(counts.entries()).map(([word,count])=>({word,count}));
  arr.sort((a,b)=> b.count - a.count);

  const carinhoFirst = arr.filter(x => CARINHO_WHITELIST.has(x.word));
  const others = arr.filter(x => !CARINHO_WHITELIST.has(x.word));
  return [...carinhoFirst, ...others].slice(0,10);
}

/*****************************************************************
 * Render principal (completo)
 *****************************************************************/
function renderAll(messages){
  // Primeira msg do Matheus
  const firstFromMatheus = messages.find(m => norm(m.author).toLowerCase().includes("matheus"));
  document.getElementById("firstMsg").textContent =
    firstFromMatheus ? `‚Äú${clip(firstFromMatheus.text, 140)}‚Äù` : "‚ÄúOi‚Ä¶‚Äù";

  // KPIs
  const totalMsgs = messages.length;
  const daysSet = new Set(messages.map(m => fmtDayKey(m.dt)));
  const totalDays = daysSet.size;

  const buckets = { "Madrugada (00-05)":0, "Manh√£ (06-11)":0, "Tarde (12-17)":0, "Noite (18-23)":0 };
  for(const m of messages){
    const h = m.dt.getHours();
    if(h <= 5) buckets["Madrugada (00-05)"]++;
    else if(h <= 11) buckets["Manh√£ (06-11)"]++;
    else if(h <= 17) buckets["Tarde (12-17)"]++;
    else buckets["Noite (18-23)"]++;
  }
  const favHour = Object.entries(buckets).sort((a,b)=>b[1]-a[1])[0]?.[0] || "‚Äî";

  const kpisEl = document.getElementById("kpis");
  kpisEl.innerHTML = "";
  kpisEl.appendChild(kpi(totalMsgs.toLocaleString("pt-BR"), "Total de mensagens"));
  kpisEl.appendChild(kpi(totalDays.toLocaleString("pt-BR"), "Total de dias conversando"));
  kpisEl.appendChild(kpi(favHour, "Hor√°rio favorito de conversa"));

  // Love bars
  const loveMsgs = messages.filter(m => isLove(m.text));
  const loveBy = countBy(loveMsgs, m => m.author);
  renderBars("loveBars", loveBy);

  // Saudade FIXA: somente as 2 mensagens que voc√™ escolheu
  renderFixedSaudade(messages);

  // Top words
  const topWords = computeTopWords(messages);
  renderBarsFromEntries("topWords", topWords);

  // Dias (best + top5)
  const byDay = countBy(messages, m => fmtDayKey(m.dt));
  const dayEntries = Object.entries(byDay).sort((a,b)=>b[1]-a[1]);
  const best = dayEntries[0];
  document.getElementById("bestDayInfo").textContent = best ? `${fmtDayKeyBR(best[0])} ‚Ä¢ ${best[1]} mensagens` : "‚Äî";
  renderTopDays(dayEntries.slice(0,5));

  // Emojis top
  renderEmojiTop(messages);

  // Fotos por autor
  renderPhotoKpis(messages);

  // Pergunta final / presente
  wireFinal();
  document.getElementById("lyricsText").textContent = LYRICS_TEXT;
}

function renderFixedSaudade(messages){
  const container = document.getElementById("saudadeFixed");
  container.innerHTML = "";

  // 1) Matheus: "Vou sentir saudade"
  const m1 = messages.find(m =>
    norm(m.author).toLowerCase().includes("matheus") &&
    norm(m.text).toLowerCase().includes("vou sentir saudade")
  );

  // 2) Clara: "Me deixou com saudades ontem s√≥ pq..."
  const m2 = messages.find(m =>
    norm(m.author).toLowerCase().includes("clara") &&
    norm(m.text).toLowerCase().includes("me deixou com saudades ontem")
  );

  const picked = [m1, m2].filter(Boolean);

  if(!picked.length){
    container.innerHTML = `<div class="muted" style="margin-top:10px;">N√£o encontrei essas duas mensagens espec√≠ficas no arquivo.</div>`;
    return;
  }

  picked.forEach(msg=>{
    const box = document.createElement("div");
    box.className = "quoteBox";
    box.innerHTML = `
      <div class="meta">${escapeHtml(msg.author)} ‚Ä¢ ${escapeHtml(fmtDT(msg.dt))}</div>
      <div>${escapeHtml(msg.text).replace(/\n/g,"<br>")}</div>
    `;
    container.appendChild(box);
  });
}

function renderTopDays(entries){
  const el = document.getElementById("topDays");
  el.innerHTML = "";
  if(!entries.length){
    el.innerHTML = `<div class="muted">Sem dados.</div>`;
    return;
  }
  const max = Math.max(...entries.map(e => e[1]));
  for(const [dayKey, val] of entries){
    const pct = max ? Math.round((val/max)*100) : 0;
    const row = document.createElement("div");
    row.className = "barRow";
    row.innerHTML = `
      <div class="badge">${escapeHtml(fmtDayKeyBR(dayKey))}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="muted" style="text-align:right">${val.toLocaleString("pt-BR")}</div>
    `;
    el.appendChild(row);
  }
}

function renderEmojiTop(messages){
  const counts = new Map();
  for(const m of messages){
    const ems = extractEmojis(m.text);
    for(const e of ems) counts.set(e, (counts.get(e) || 0) + 1);
  }
  const top = Array.from(counts.entries())
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10);

  const el = document.getElementById("emojiChips");
  el.innerHTML = "";
  if(!top.length){
    el.innerHTML = `<div class="muted">Sem emojis detectados.</div>`;
    return;
  }
  top.forEach(([emo, n])=>{
    const d = document.createElement("div");
    d.className = "chip";
    d.innerHTML = `<span style="font-size:18px">${escapeHtml(emo)}</span> <small>${n}</small>`;
    el.appendChild(d);
  });
}

function renderPhotoKpis(messages){
  const photoMsgs = messages.filter(m => isPhotoMessage(m.text));
  const by = countBy(photoMsgs, m => m.author);
  const entries = Object.entries(by).sort((a,b)=>b[1]-a[1]);

  const el = document.getElementById("photoKpis");
  el.innerHTML = "";

  if(!entries.length){
    el.innerHTML = `<div class="muted">Sem fotos detectadas no formato ‚Äúimagem ocultada/omitida‚Äù.</div>`;
    return;
  }

  // Mostra 2 caixas: Matheus e Clara (se existirem)
  const matheus = entries.find(e => norm(e[0]).toLowerCase().includes("matheus"));
  const clara   = entries.find(e => norm(e[0]).toLowerCase().includes("clara"));

  const list = [matheus, clara].filter(Boolean);
  if(!list.length){
    // fallback: top 2
    list.push(...entries.slice(0,2));
  }

  list.forEach(([name,val])=>{
    el.appendChild(kpi(val.toLocaleString("pt-BR"), `Fotos enviadas ‚Äî ${shortName(name)}`));
  });
}

function wireFinal(){
  const openQuestionBtn = document.getElementById("openQuestionBtn");
  const questionBox = document.getElementById("questionBox");
  const noToast = document.getElementById("noToast");
  const secGift = document.getElementById("sec-gift");

  openQuestionBtn.onclick = ()=>{
    questionBox.classList.remove("hidden");
    questionBox.scrollIntoView({ behavior:"smooth", block:"center" });
  };

  function accepted(){
    secGift.classList.remove("hidden");
    secGift.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  document.getElementById("yesBtn").onclick = accepted;
  document.getElementById("obviousBtn").onclick = accepted;
  document.getElementById("noBtn").onclick = ()=>{
    noToast.style.display = "block";
    setTimeout(()=>{ noToast.style.display="none"; }, 1400);
  };
}

/*****************************************************************
 * UI helpers
 *****************************************************************/
function kpi(value, label){
  const div = document.createElement("div");
  div.className = "kpi";
  div.innerHTML = `<div class="v">${escapeHtml(value)}</div><div class="l">${escapeHtml(label)}</div>`;
  return div;
}

function renderBars(containerId, mapObj){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  const entries = Object.entries(mapObj).sort((a,b)=>b[1]-a[1]);
  if(!entries.length){
    el.innerHTML = `<div class="muted">Nenhuma declara√ß√£o detectada ainda üòÖ</div>`;
    return;
  }
  const max = Math.max(...entries.map(e => e[1]));
  for(const [name, val] of entries){
    const row = document.createElement("div");
    row.className = "barRow";
    const pct = max ? Math.round((val/max)*100) : 0;
    row.innerHTML = `
      <div class="badge" title="${escapeHtml(name)}">${escapeHtml(shortName(name))}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="muted" style="text-align:right">${val.toLocaleString("pt-BR")}</div>
    `;
    el.appendChild(row);
  }
}

function renderBarsFromEntries(containerId, entries){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  if(!entries.length){
    el.innerHTML = `<div class="muted">Sem palavras detectadas.</div>`;
    return;
  }
  const max = Math.max(...entries.map(e => e.count));
  entries.forEach(({word, count})=>{
    const pct = max ? Math.round((count/max)*100) : 0;
    const row = document.createElement("div");
    row.className = "barRow";
    row.innerHTML = `
      <div class="badge">${escapeHtml(word)}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="muted" style="text-align:right">${count}</div>
    `;
    el.appendChild(row);
  });
}

/*****************************************************************
 * Utils
 *****************************************************************/
function countBy(arr, fn){
  const out = {};
  for(const x of arr){
    const k = fn(x);
    out[k] = (out[k] || 0) + 1;
  }
  return out;
}
function fmtDayKey(dt){
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function fmtDayKeyBR(dayKey){
  const [y,m,d] = dayKey.split("-");
  return `${d}/${m}/${y}`;
}
function fmtDT(dt){
  const d = String(dt.getDate()).padStart(2,"0");
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const y = dt.getFullYear();
  const hh = String(dt.getHours()).padStart(2,"0");
  const mm = String(dt.getMinutes()).padStart(2,"0");
  return `${d}/${m}/${y} ${hh}:${mm}`;
}
function shortName(name){
  const parts = (name || "").trim().split(/\s+/).filter(Boolean);
  if(parts.length <= 1) return name || "";
  return `${parts[0]} ${parts[parts.length-1][0]}.`;
}
function clip(s, n){
  const t = String(s || "").replace(/\s+/g," ").trim();
  if(t.length <= n) return t;
  return t.slice(0, n-1) + "‚Ä¶";
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function norm(s){
  return String(s ?? "").replace(/[\u200E\u200F\u202A-\u202E]/g,"").trim();
}
</script>
</body>
</html>
