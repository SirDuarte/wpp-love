<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matheus + Clara</title>
  <style>
    :root{
      --bg:#0b0b10;
      --card:#141422;
      --muted:#b7b7c6;
      --text:#f2f2ff;
      --accent:#ff4d8d;
      --accent2:#7c5cff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,77,141,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(124,92,255,.22), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .hidden{ display:none !important; }

    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: radial-gradient(900px 600px at 20% 0%, rgba(255,77,141,.22), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(124,92,255,.18), transparent 60%),
                  rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      z-index:9999;
    }
    .overlayCard{
      width:min(760px, 100%);
      border-radius:24px;
      padding:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,20,34,.88);
      box-shadow: var(--shadow);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      cursor:pointer;
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border:0; color:white;
      padding:10px 12px; border-radius:12px;
      font-weight:650; font-size:13px;
      box-shadow: 0 12px 26px rgba(255,77,141,.18);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btnGhost{
      cursor:pointer;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      padding:10px 12px; border-radius:12px;
      font-weight:650; font-size:13px;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    /* ---------- ALBUM ---------- */
    .albumWrap{ display:grid; gap:12px; }
    .albumTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .albumTitle{ display:flex; flex-direction:column; gap:4px; }
    .albumTitle h1{ margin:0; font-size:18px; }
    .albumTitle p{ margin:0; color:var(--muted); font-size:13px; }

    .frame{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .frame img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.02);
    }
    .frame::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.55));
      pointer-events:none;
    }
    .caption{
      position:absolute; left:14px; right:14px; bottom:12px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
      z-index:3;
    }
    .caption .big{
      font-size:18px; font-weight:800; letter-spacing:.2px; margin:0;
      text-shadow: 0 10px 26px rgba(0,0,0,.5);
    }
    .caption .small{
      margin:6px 0 0; color: rgba(255,255,255,.82); font-size:12px; line-height:1.35;
      text-shadow: 0 10px 26px rgba(0,0,0,.55);
    }
    .dots{ display:flex; gap:6px; justify-content:center; padding-top:2px; }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }
    .dot.active{ background: rgba(255,77,141,.85); border-color: rgba(255,77,141,.55); }

    .finalAsk{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      gap:10px;
      z-index:4;
      text-align:center;
      padding:18px;
    }
    .glass{
      background: rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:14px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: 680px;
    }
    .finalAsk h2{ margin:0; font-size:28px; letter-spacing:.3px; }
    .finalAsk p{ margin:10px 0 0; color: rgba(255,255,255,.86); font-size:13px; line-height:1.4; }

    .placeholder{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:2;
      padding:16px;
      text-align:center;
    }
    .placeholder .box{
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: 560px;
    }
    .placeholder .t{ margin:0; font-weight:850; font-size:16px; }
    .placeholder .s{ margin:8px 0 0; color: rgba(255,255,255,.82); font-size:12px; line-height:1.4; }

    /* ---------- PIN ---------- */
    .pinRow{ display:flex; gap:10px; align-items:center; margin-top:14px; }
    .pinInput{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      display:none;
    }

    /* ---------- APP ---------- */
    header{
      padding:28px 18px 12px;
      max-width:1100px; margin:0 auto;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
    }
    .title h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; max-width:780px;}
    main{ max-width:1100px; margin:0 auto; padding:0 18px 40px; }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; }
    .card{
      grid-column: span 12;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .card h2{ margin:0 0 10px; font-size:14px; letter-spacing:.2px;}
    .hr{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }

    .kpi{
      display:flex; flex-direction:column; gap:6px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      min-width: 180px;
    }
    .kpi .v{ font-size:20px; font-weight:750; }
    .kpi .l{ font-size:12px; color:var(--muted); }

    .barWrap{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .barRow{ display:grid; grid-template-columns: 160px 1fr 80px; gap:10px; align-items:center; }
    .bar{
      height:12px; border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border-radius:999px;
    }

    .miniChart{
      display:flex; gap:3px; align-items:flex-end;
      height:44px; padding:10px 10px 6px;
      border-radius:14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .miniChart span{
      width:6px; border-radius:6px;
      background: rgba(255,255,255,.16);
    }

    .quoteBox{
      margin-top:12px;
      padding:12px 12px;
      border-left:3px solid rgba(255,77,141,.7);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
    }
    .quoteBox .meta{ color: var(--muted); font-size:12px; margin-bottom:6px;}

    /* Toast Quote */
    .toastQuote{
      position: fixed;
      left: 14px;
      right: 14px;
      bottom: 14px;
      max-width: 900px;
      margin: 0 auto;
      z-index: 9998;
      display:none;
    }
    .toastQuoteInner{
      border-radius:18px;
      padding:14px 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(20,20,34,.92);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .toastQuoteInner .t{ font-weight:800; margin:0 0 6px; }
    .toastQuoteInner .m{ margin:0; color: rgba(255,255,255,.85); line-height:1.35; }
    .toastQuoteInner .x{ margin-top:10px; display:flex; justify-content:flex-end; }

    @media(min-width:900px){
      .card.span6{ grid-column: span 6; }
    }
  </style>
</head>

<body>

  <!-- 1) ALBUM -->
  <div class="overlay" id="albumOverlay">
    <div class="overlayCard">
      <div class="albumWrap">
        <div class="albumTop">
          <div class="albumTitle">
            <h1>üíû Matheus + Clara</h1>
            <p>Um pedacinho da nossa hist√≥ria‚Ä¶</p>
          </div>
          <span class="badge" id="albumCount">1/5</span>
        </div>

        <div class="frame">
          <img id="albumImg" alt="Foto do √°lbum" />
          <div class="placeholder hidden" id="photoPlaceholder">
            <div class="box">
              <p class="t">Foto n√£o carregou üòÖ</p>
              <p class="s">
                Coloque 5 fotos em <span class="mono">assets/photos/</span> com nomes:
                <span class="mono">01.jpg</span> at√© <span class="mono">05.jpg</span> (pode ser .jpeg/.png).
              </p>
            </div>
          </div>

          <div class="caption">
            <div>
              <p class="big" id="albumBig">‚Äî</p>
              <p class="small" id="albumSmall">‚Äî</p>
            </div>
            <span class="badge" id="albumTag">üíó</span>
          </div>

          <!-- Pergunta final -->
          <div class="finalAsk hidden" id="finalAsk">
            <div class="glass">
              <h2>Quer namorar comigo?</h2>
              <p>
                Eu quero viver tudo isso com voc√™ ‚Äî com calma, com verdade e com Deus na frente.
              </p>
              <div class="row" style="justify-content:center; margin-top:12px;">
                <button class="btn" id="goPin">Continuar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="dots" id="dots"></div>

        <div class="row" style="justify-content:space-between;">
          <button class="btnGhost" id="prevBtn">‚óÄ Anterior</button>
          <button class="btn" id="nextBtn">Pr√≥ximo ‚ñ∂</button>
        </div>

        <div class="muted">
          Chat: <span class="mono">assets/chat/_chat.txt</span> ‚Ä¢ Fotos: <span class="mono">assets/photos/01..05</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 2) PIN -->
  <div class="overlay hidden" id="pinOverlay">
    <div class="overlayCard">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="badge">üîí Acesso</div>
          <h2 style="margin:10px 0 0;">Digite a data</h2>
          <div class="muted" style="margin-top:6px;">Formato: <span class="mono">DD/MM</span></div>
        </div>
      </div>

      <div class="pinRow">
        <input class="pinInput" id="pin" placeholder="DD/MM" inputmode="numeric" />
        <button class="btn" id="enterBtn">Entrar</button>
      </div>
      <div class="toast" id="toast">Data inv√°lida.</div>
    </div>
  </div>

  <!-- Toast de frase -->
  <div class="toastQuote" id="toastQuote">
    <div class="toastQuoteInner">
      <p class="t">‚ú®</p>
      <p class="m" id="toastQuoteText">‚Äî</p>
      <div class="x"><button class="btnGhost" id="toastClose">Fechar</button></div>
    </div>
  </div>

  <!-- 3) APP -->
  <div id="app" class="hidden">
    <header>
      <div class="title">
        <h1>üíå Nosso WhatsApp</h1>
        <p id="sourceInfo">Carregando conversa‚Ä¶</p>
      </div>
      <div class="badge" id="statusBadge">Carregando‚Ä¶</div>
    </header>

    <main>
      <div class="grid">
        <div class="card span6" id="sec-kpis">
          <h2>Resumo</h2>
          <div class="row" id="kpis">
            <div class="kpi"><div class="v">‚Äî</div><div class="l">Total de mensagens</div></div>
            <div class="kpi"><div class="v">‚Äî</div><div class="l">Quem falou mais</div></div>
            <div class="kpi"><div class="v">‚Äî</div><div class="l">Primeiro ‚Äúte amo‚Äù</div></div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <button class="btnGhost" id="reloadBtn">Recarregar conversa</button>
            <span class="muted" id="loadInfo"></span>
          </div>
        </div>

        <div class="card span6" id="sec-bars">
          <h2>Mensagens por pessoa</h2>
          <div class="barWrap" id="bars"></div>
        </div>

        <div class="card span6" id="sec-timeline">
          <h2>Linha do tempo (mensagens por dia)</h2>
          <div class="muted">Quanto mais alta a barrinha, mais voc√™s conversaram naquele dia.</div>
          <div class="miniChart" id="miniChart"></div>
        </div>

        <div class="card span6" id="sec-love">
          <h2>‚ÄúEu te amo‚Äù e varia√ß√µes</h2>
          <div class="muted">Contagem por pessoa</div>
          <div class="barWrap" id="loveBars"></div>

          <div class="quoteBox" id="firstLoveBox">
            <div class="meta">‚Äî</div>
            <div>‚Äî</div>
          </div>
        </div>

        <div class="card" id="sec-notes">
          <h2>Notas</h2>
          <div class="muted">
            ‚Ä¢ Se foto n√£o carregar: confira nomes <span class="mono">01..05</span> em <span class="mono">assets/photos/</span>.<br>
            ‚Ä¢ Se chat n√£o carregar: confirme <span class="mono">assets/chat/_chat.txt</span>.
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
  /*****************************************************************
   * CONFIG ‚Äî ajuste s√≥ se seu GitHub for diferente
   *****************************************************************/
  const OWNER  = "SirDuarte";
  const REPO   = "wpp-love";
  const BRANCH = "main";

  // Senha esperada (N√ÉO aparece em lugar nenhum)
  const EXPECTED_PIN_NUMBERS = "0702"; // 07/02

  // Chat (sempre nesse caminho no repo)
  const CHAT_LOCAL = "./assets/chat/_chat.txt";
  const CHAT_RAW   = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/assets/chat/_chat.txt`;

  // Fotos: voc√™ colocou 5 imagens ‚Üí 01..05
  const PHOTO_NUMBERS = ["01","02","03","04","05"];
  const PHOTO_EXTS = [".jpg",".jpeg",".png",".webp"]; // tenta todas

  // Textos do √°lbum (pode editar)
  const ALBUM_TEXT = [
    { big:"A gente",       small:"Do jeitinho que Deus escreveu.",               tag:"üíó" },
    { big:"Nossa hist√≥ria",small:"Feita de detalhes, risadas e cuidado.",        tag:"‚ú®" },
    { big:"Eu + voc√™",     small:"E a certeza de que vale a pena.",              tag:"ü§ç" },
    { big:"Caminho",       small:"Com calma, com verdade e f√©.",                 tag:"üåô" },
    { big:"Futuro",        small:"O melhor de Deus ainda est√° por vir.",         tag:"üåπ" }
  ];

  /*****************************************************************
   * HELPERS de URL (corrige base do GitHub Pages)
   *****************************************************************/
  function absFromHere(relPath){
    return new URL(relPath, window.location.href).toString();
  }

  function rawPhotoUrl(num, ext){
    return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/assets/photos/${num}${ext}`;
  }
  function localPhotoUrl(num, ext){
    return absFromHere(`./assets/photos/${num}${ext}`);
  }

  async function fetchOk(url){
    try{
      const res = await fetch(url, { cache:"no-store" });
      return res.ok;
    }catch(e){
      return false;
    }
  }

  async function findFirstWorkingUrl(urls){
    for(const u of urls){
      if(await fetchOk(u)) return u;
    }
    return null;
  }

  /*****************************************************************
   * ALBUM
   *****************************************************************/
  const albumOverlay = document.getElementById("albumOverlay");
  const pinOverlay = document.getElementById("pinOverlay");
  const albumImg = document.getElementById("albumImg");
  const photoPlaceholder = document.getElementById("photoPlaceholder");

  const albumBig = document.getElementById("albumBig");
  const albumSmall = document.getElementById("albumSmall");
  const albumTag = document.getElementById("albumTag");
  const albumCount = document.getElementById("albumCount");

  const dots = document.getElementById("dots");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  const finalAsk = document.getElementById("finalAsk");
  const goPin = document.getElementById("goPin");

  let albumIndex = 0;

  function renderDots(){
    dots.innerHTML = "";
    for(let i=0;i<PHOTO_NUMBERS.length;i++){
      const d = document.createElement("div");
      d.className = "dot" + (i===albumIndex ? " active" : "");
      d.onclick = async ()=>{ albumIndex=i; await renderAlbum(); };
      dots.appendChild(d);
    }
  }

  async function renderAlbum(){
    const num = PHOTO_NUMBERS[albumIndex];
    const text = ALBUM_TEXT[albumIndex] || { big:"", small:"", tag:"üíó" };

    albumBig.textContent = text.big;
    albumSmall.textContent = text.small;
    albumTag.textContent = text.tag || "üíó";
    albumCount.textContent = `${albumIndex+1}/${PHOTO_NUMBERS.length}`;

    prevBtn.disabled = albumIndex === 0;

    // √öltimo slide: mostra a pergunta
    const isLast = albumIndex === PHOTO_NUMBERS.length - 1;
    finalAsk.classList.toggle("hidden", !isLast);

    renderDots();

    // Tenta carregar foto com m√∫ltiplas extens√µes + fallback raw
    photoPlaceholder.classList.add("hidden");
    albumImg.removeAttribute("src");

    const candidates = [];
    for(const ext of PHOTO_EXTS){
      candidates.push(localPhotoUrl(num, ext));
    }
    for(const ext of PHOTO_EXTS){
      candidates.push(rawPhotoUrl(num, ext));
    }

    const okUrl = await findFirstWorkingUrl(candidates);
    if(okUrl){
      albumImg.src = okUrl;
    } else {
      photoPlaceholder.classList.remove("hidden");
    }
  }

  prevBtn.onclick = async ()=>{
    albumIndex = Math.max(0, albumIndex-1);
    await renderAlbum();
  };
  nextBtn.onclick = async ()=>{
    albumIndex = Math.min(PHOTO_NUMBERS.length-1, albumIndex+1);
    await renderAlbum();
  };

  goPin.onclick = ()=>{
    albumOverlay.classList.add("hidden");
    pinOverlay.classList.remove("hidden");
    document.getElementById("pin").focus();
  };

  renderAlbum();

  /*****************************************************************
   * PIN
   *****************************************************************/
  const pin = document.getElementById("pin");
  const enterBtn = document.getElementById("enterBtn");
  const toast = document.getElementById("toast");

  function normPinDigits(s){ return (s||"").replace(/\D/g,""); }

  function tryEnter(){
    const digits = normPinDigits(pin.value);
    if(digits === EXPECTED_PIN_NUMBERS){
      toast.style.display = "none";
      pinOverlay.classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      localStorage.setItem("wpp_pin_ok", "1");
      loadAndRender();
    } else {
      toast.style.display = "block";
      toast.textContent = "Data inv√°lida.";
    }
  }

  enterBtn.onclick = tryEnter;
  pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryEnter(); });

  // Mant√©m logado no mesmo dispositivo
  if (localStorage.getItem("wpp_pin_ok") === "1") {
    albumOverlay.classList.add("hidden");
    pinOverlay.classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    loadAndRender();
  }

  /*****************************************************************
   * FRASE (aparece em momentos ao rolar)
   *****************************************************************/
  const toastQuote = document.getElementById("toastQuote");
  const toastQuoteText = document.getElementById("toastQuoteText");
  const toastClose = document.getElementById("toastClose");

  const QUOTE_1 = "Carregue em seu cora√ß√£o a certeza de que sempre valer√° a pena esperar. O nosso tempo tem pressa, o tempo de Deus tem perfei√ß√£o.";

  function showQuote(text){
    toastQuoteText.textContent = text;
    toastQuote.style.display = "block";
  }
  toastClose.onclick = ()=>{ toastQuote.style.display="none"; };

  function setupQuoteTriggers(){
    const triggered = new Set();

    const map = [
      { id: "sec-bars", quote: QUOTE_1 },
      // voc√™ pode adicionar mais depois:
      // { id: "sec-love", quote: "..." },
    ];

    const obs = new IntersectionObserver((entries)=>{
      for(const e of entries){
        if(e.isIntersecting){
          const id = e.target.id;
          const item = map.find(x => x.id === id);
          if(item && !triggered.has(id)){
            triggered.add(id);
            showQuote(item.quote);
          }
        }
      }
    }, { threshold: 0.45 });

    map.forEach(x=>{
      const el = document.getElementById(x.id);
      if(el) obs.observe(el);
    });
  }

  /*****************************************************************
   * LOAD CHAT (local + raw fallback)
   *****************************************************************/
  const statusBadge = document.getElementById("statusBadge");
  const loadInfo = document.getElementById("loadInfo");
  const reloadBtn = document.getElementById("reloadBtn");
  const sourceInfo = document.getElementById("sourceInfo");

  reloadBtn.onclick = loadAndRender;

  async function loadAndRender(){
    statusBadge.textContent = "Carregando‚Ä¶";
    loadInfo.textContent = "";
    sourceInfo.textContent = "Carregando conversa‚Ä¶";

    const chatCandidates = [absFromHere(CHAT_LOCAL), CHAT_RAW];
    let text = null;
    let used = null;

    for(const url of chatCandidates){
      try{
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        text = await res.text();
        used = url;
        break;
      }catch(e){
        // tenta pr√≥ximo
      }
    }

    if(!text){
      statusBadge.textContent = "Falha ao carregar";
      sourceInfo.textContent = "N√£o consegui carregar o chat.";
      loadInfo.textContent = "Confirme: assets/chat/_chat.txt (commitado).";
      return;
    }

    const messages = parseWhatsApp(text).filter(m => !isSystemMessage(m.text));
    if(!messages.length){
      statusBadge.textContent = "Sem dados";
      sourceInfo.textContent = `Fonte: ${used}`;
      loadInfo.textContent = "Carregou, mas n√£o consegui ler mensagens no formato exportado.";
      return;
    }

    statusBadge.textContent = "Pronto üíó";
    sourceInfo.textContent = `Fonte: ${used}`;
    loadInfo.textContent = `Lidas ${messages.length.toLocaleString("pt-BR")} mensagens`;

    renderAll(messages);
    setupQuoteTriggers();
  }

  /*****************************************************************
   * PARSER WhatsApp
   *****************************************************************/
  const lineStartRe = /^\[(\d{2}\/\d{2}\/\d{4}),\s(\d{2}:\d{2}:\d{2})\]\s([^:]+):\s(.*)$/;

  function parseWhatsApp(text){
    const lines = (text || "").replace(/\r\n/g, "\n").split("\n");
    const out = [];
    let cur = null;

    for(const raw of lines){
      const line = raw ?? "";
      const m = line.match(lineStartRe);
      if(m){
        if(cur) out.push(cur);
        const [_, dateStr, timeStr, author, msg] = m;
        cur = { dt: parseBRDateTime(dateStr, timeStr), author: author.trim(), text: (msg || "").trim() };
      } else {
        if(cur){
          cur.text += (cur.text ? "\n" : "") + line.trimEnd();
        }
      }
    }
    if(cur) out.push(cur);
    return out.filter(x => x.author && x.dt && typeof x.text === "string");
  }

  function parseBRDateTime(d, t){
    const [dd, mm, yyyy] = d.split("/").map(Number);
    const [HH, MM, SS] = t.split(":").map(Number);
    return new Date(yyyy, mm-1, dd, HH, MM, SS);
  }

  function isSystemMessage(text){
    const s = (text || "").toLowerCase();
    return (
      s.includes("criptografia de ponta a ponta") ||
      s.includes("mensagens e liga√ß√µes s√£o protegidas") ||
      s.includes("omitiu") ||
      s.includes("imagem omitida") ||
      s.includes("v√≠deo omitido") || s.includes("video omitido") ||
      s.includes("√°udio omitido") || s.includes("audio omitido") ||
      s.includes("figurinha omitida") ||
      s.includes("documento omitido") ||
      s.includes("localiza√ß√£o omitida") || s.includes("localizacao omitida") ||
      s.startsWith("‚Äé")
    );
  }

  /*****************************************************************
   * LOVE
   *****************************************************************/
  const lovePatterns = [
    /\beu\s*te\s*amo+\b/i,
    /\bte\s*amo+\b/i,
    /\bt\s*amo+\b/i,
    /\bamo\s*(voc√™|voce|vc|tu)\b/i,
    /\bte\s*adoro+\b/i,
    /\bsou\s*apaixonad[oa]\b/i,
    /\bt[o√¥]\s*com\s*saudade\b/i
  ];
  function isLove(text){
    const s = (text || "").trim();
    return !!s && lovePatterns.some(re => re.test(s));
  }

  /*****************************************************************
   * RENDER
   *****************************************************************/
  function renderAll(messages){
    const totalBy = countBy(messages, m => m.author);
    const totalMsgs = messages.length;
    const [topName, topCount] = topEntry(totalBy);

    const loveMsgs = messages.filter(m => isLove(m.text));
    const loveBy = countBy(loveMsgs, m => m.author);
    const firstLove = loveMsgs.length ? loveMsgs.slice().sort((a,b)=>a.dt-b.dt)[0] : null;

    const kpis = document.getElementById("kpis");
    kpis.innerHTML = "";
    kpis.appendChild(kpi(totalMsgs.toLocaleString("pt-BR"), "Total de mensagens"));
    kpis.appendChild(kpi(topName ? `${topName}` : "‚Äî", topName ? `Falou mais (${topCount.toLocaleString("pt-BR")})` : "Quem falou mais"));
    kpis.appendChild(kpi(firstLove ? firstLove.author : "‚Äî", firstLove ? `Primeiro ‚Äúte amo‚Äù (${fmtDT(firstLove.dt)})` : "Primeiro ‚Äúte amo‚Äù"));

    renderBars("bars", totalBy);
    const byDay = countBy(messages, m => fmtDayKey(m.dt));
    renderMiniChart("miniChart", byDay);

    renderBars("loveBars", loveBy, true);
    renderFirstLove(firstLove);
  }

  function kpi(value, label){
    const div = document.createElement("div");
    div.className = "kpi";
    div.innerHTML = `<div class="v">${escapeHtml(value)}</div><div class="l">${escapeHtml(label)}</div>`;
    return div;
  }

  function renderBars(containerId, mapObj, isLove=false){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    const entries = Object.entries(mapObj).sort((a,b)=>b[1]-a[1]);
    if(!entries.length){
      el.innerHTML = `<div class="muted">${isLove ? "Nenhuma declara√ß√£o detectada ainda üòÖ" : "Sem dados"}</div>`;
      return;
    }
    const max = Math.max(...entries.map(e => e[1]));
    for(const [name, val] of entries){
      const row = document.createElement("div");
      row.className = "barRow";
      const pct = max ? Math.round((val/max)*100) : 0;
      row.innerHTML = `
        <div class="badge" title="${escapeHtml(name)}">${escapeHtml(shortName(name))}</div>
        <div class="bar"><i style="width:${pct}%"></i></div>
        <div class="muted" style="text-align:right">${val.toLocaleString("pt-BR")}</div>
      `;
      el.appendChild(row);
    }
  }

  function renderMiniChart(containerId, byDayObj){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    const days = Object.entries(byDayObj).sort((a,b)=>a[0].localeCompare(b[0]));
    if(!days.length){ return; }
    const values = days.map(d => d[1]);
    const max = Math.max(...values);
    const sliced = days.slice(Math.max(0, days.length - 90));
    for(const [dayKey, val] of sliced){
      const h = max ? Math.max(3, Math.round((val/max)*40)) : 3;
      const b = document.createElement("span");
      b.style.height = `${h}px`;
      b.title = `${dayKey} ‚Ä¢ ${val} msg`;
      el.appendChild(b);
    }
  }

  function renderFirstLove(firstLove){
    const box = document.getElementById("firstLoveBox");
    if(!firstLove){
      box.innerHTML = `<div class="meta">‚Äî</div><div>N√£o encontrei nenhuma varia√ß√£o de ‚Äúte amo‚Äù.</div>`;
      return;
    }
    box.innerHTML = `
      <div class="meta">${escapeHtml(firstLove.author)} ‚Ä¢ ${escapeHtml(fmtDT(firstLove.dt))}</div>
      <div>${escapeHtml(firstLove.text).replace(/\n/g,"<br>")}</div>
    `;
  }

  function countBy(arr, fn){
    const out = {};
    for(const x of arr){
      const k = fn(x);
      out[k] = (out[k] || 0) + 1;
    }
    return out;
  }
  function topEntry(obj){
    const entries = Object.entries(obj);
    if(!entries.length) return [null, 0];
    entries.sort((a,b)=>b[1]-a[1]);
    return entries[0];
  }
  function fmtDayKey(dt){
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,"0");
    const d = String(dt.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  function fmtDT(dt){
    const d = String(dt.getDate()).padStart(2,"0");
    const m = String(dt.getMonth()+1).padStart(2,"0");
    const y = dt.getFullYear();
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${d}/${m}/${y} ${hh}:${mm}`;
  }
  function shortName(name){
    const parts = (name || "").trim().split(/\s+/).filter(Boolean);
    if(parts.length <= 1) return name || "";
    return `${parts[0]} ${parts[parts.length-1][0]}.`;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>
</body>
</html>
