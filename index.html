<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matheus + Clara</title>

  <style>
    :root{
      --bg:#0b0b10;
      --muted:#b7b7c6;
      --text:#f2f2ff;
      --accent:#ff4d8d;
      --accent2:#7c5cff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,77,141,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(124,92,255,.22), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .hidden{ display:none !important; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    .btn{
      cursor:pointer;
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border:0; color:white;
      padding:10px 12px; border-radius:12px;
      font-weight:750; font-size:13px;
      box-shadow: 0 12px 26px rgba(255,77,141,.18);
      transition: transform .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btnGhost{
      cursor:pointer;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      padding:10px 12px; border-radius:12px;
      font-weight:750; font-size:13px;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px; color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }

    /* ---------- Overlays ---------- */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: radial-gradient(900px 600px at 20% 0%, rgba(255,77,141,.22), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(124,92,255,.18), transparent 60%),
                  rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      z-index:9999;
    }
    .overlayCard{
      width:min(820px, 100%);
      border-radius:24px;
      padding:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,20,34,.88);
      box-shadow: var(--shadow);
    }

    /* ---------- Album ---------- */
    .albumWrap{ display:grid; gap:12px; }
    .albumTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .albumTitle{ display:flex; flex-direction:column; gap:4px; }
    .albumTitle h1{ margin:0; font-size:18px; }
    .albumTitle p{ margin:0; color:var(--muted); font-size:13px; }

    .frame{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .frame img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.02);
    }
    .frame::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.55));
      pointer-events:none;
    }
    .caption{
      position:absolute; left:14px; right:14px; bottom:12px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
      z-index:3;
    }
    .caption .big{
      font-size:18px; font-weight:850; letter-spacing:.2px; margin:0;
      text-shadow: 0 10px 26px rgba(0,0,0,.5);
    }
    .caption .small{
      margin:6px 0 0; color: rgba(255,255,255,.84); font-size:12px; line-height:1.35;
      text-shadow: 0 10px 26px rgba(0,0,0,.55);
    }
    .dots{ display:flex; gap:6px; justify-content:center; padding-top:2px; }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }
    .dot.active{ background: rgba(255,77,141,.85); border-color: rgba(255,77,141,.55); }

    .placeholder{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:2;
      padding:16px;
      text-align:center;
    }
    .placeholder .box{
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: 640px;
    }
    .placeholder .t{ margin:0; font-weight:900; font-size:16px; }
    .placeholder .s{ margin:8px 0 0; color: rgba(255,255,255,.82); font-size:12px; line-height:1.4; }

    /* ---------- PIN ---------- */
    .pinRow{ display:flex; gap:10px; align-items:center; margin-top:14px; }
    .pinInput{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      display:none;
    }

    /* ---------- App ---------- */
    header{
      padding:26px 18px 10px;
      max-width:1120px; margin:0 auto;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
    }
    .topActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .title h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; max-width:820px;}
    main{ max-width:1120px; margin:0 auto; padding:0 18px 46px; }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; }
    .card{
      grid-column: span 12;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .card h2{ margin:0 0 10px; font-size:14px; letter-spacing:.2px;}
    .hr{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }

    .heroBox{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:14px;
    }
    .heroMsg{
      font-size:16px;
      font-weight:900;
      margin:0 0 8px;
    }
    .heroSub{
      margin:0;
      color: rgba(255,255,255,.84);
      line-height:1.4;
    }

    .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      display:flex; flex-direction:column; gap:6px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      min-width: 210px;
      flex: 1 1 210px;
    }
    .kpi .v{ font-size:22px; font-weight:850; }
    .kpi .l{ font-size:12px; color:var(--muted); }

    .barWrap{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .barRow{ display:grid; grid-template-columns: 170px 1fr 80px; gap:10px; align-items:center; }
    .bar{
      height:12px; border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      border-radius:999px;
    }

    /* Timeline */
    .timeline{ display:grid; gap:10px; margin-top:8px; }
    .tlItem{
      display:flex;
      gap:12px;
      align-items:flex-start;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .tlDot{
      width:12px; height:12px;
      margin-top:4px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(124,92,255,.95));
      box-shadow: 0 8px 20px rgba(255,77,141,.18);
      flex: 0 0 12px;
    }
    .tlDate{
      font-weight:900;
      letter-spacing:.2px;
      margin:0;
    }
    .tlText{
      margin:6px 0 0;
      color: rgba(255,255,255,.85);
      line-height:1.4;
      font-size:13px;
    }

    /* Emojis */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
      font-size:13px;
    }
    .chip small{ color: var(--muted); font-weight:900; font-size:12px; }

    /* Final */
    .pulse{ animation: pulse 1.4s ease-in-out infinite; }
    @keyframes pulse{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.02); }
      100%{ transform: scale(1); }
    }
    .heartBig{
      font-size:84px;
      line-height:1;
      margin:0;
      text-align:center;
      filter: drop-shadow(0 16px 30px rgba(255,77,141,.18));
    }
    .lyrics{
      margin:12px auto 0;
      max-width:760px;
      text-align:center;
      line-height:1.65;
      color: rgba(255,255,255,.90);
      font-weight:750;
      white-space:pre-line;
    }

    @media(min-width:900px){
      .card.span6{ grid-column: span 6; }
    }
  </style>

  <!-- ‚úÖ Chat ‚Äúgarantido‚Äù como JS -->
  <script src="./assets/chat/chat.js"></script>
</head>

<body>

  <!-- 1) ALBUM -->
  <div class="overlay" id="albumOverlay">
    <div class="overlayCard">
      <div class="albumWrap">
        <div class="albumTop">
          <div class="albumTitle">
            <h1>üíû Matheus + Clara</h1>
            <p>Um pedacinho da nossa hist√≥ria‚Ä¶</p>
          </div>
          <span class="badge" id="albumCount">1/5</span>
        </div>

        <div class="frame">
          <img id="albumImg" alt="Foto do √°lbum" />
          <div class="placeholder hidden" id="photoPlaceholder">
            <div class="box">
              <p class="t">Foto n√£o carregou üòÖ</p>
              <p class="s">
                Coloque 5 fotos em <span class="mono">assets/photos/</span> com nomes:
                <span class="mono">01</span> at√© <span class="mono">05</span> (ext: jpg/jpeg/png/webp).
              </p>
            </div>
          </div>

          <div class="caption">
            <div>
              <p class="big" id="albumBig">‚Äî</p>
              <p class="small" id="albumSmall">‚Äî</p>
            </div>
            <span class="badge" id="albumTag">üíó</span>
          </div>
        </div>

        <div class="dots" id="dots"></div>

        <div class="row" style="justify-content:space-between;">
          <button class="btnGhost" id="prevBtn">‚óÄ Anterior</button>
          <button class="btn" id="nextBtn">Pr√≥ximo ‚ñ∂</button>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button class="btn" id="goPinFromAlbum">Continuar üîí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 2) PIN -->
  <div class="overlay hidden" id="pinOverlay">
    <div class="overlayCard">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="badge">üîí Acesso</div>
          <h2 style="margin:10px 0 0;">Digite a data</h2>
          <div class="muted" style="margin-top:6px;">Formato: <span class="mono">DD/MM</span></div>
        </div>
        <button class="btnGhost" id="backToAlbum">‚Üê Voltar</button>
      </div>

      <div class="pinRow">
        <input class="pinInput" id="pin" placeholder="DD/MM" inputmode="numeric" />
        <button class="btn" id="enterBtn">Entrar</button>
      </div>
      <div class="toast" id="toast">Data inv√°lida.</div>
    </div>
  </div>

  <!-- 3) APP -->
  <div id="app" class="hidden">
    <header>
      <div class="title">
        <h1>üíå Matheus + Clara</h1>
        <p>Feito com carinho, a partir da nossa conversa.</p>
      </div>
      <div class="topActions">
        <span class="badge" id="statusBadge">Carregando‚Ä¶</span>
        <button class="btnGhost" id="restartBtn">‚ü≤ Recome√ßar</button>
      </div>
    </header>

    <main>
      <div class="grid">

        <!-- PAGE 1: O COME√áO (ap√≥s PIN) -->
        <div class="card" id="sec-start">
          <h2>O come√ßo</h2>
          <div class="heroBox">
            <p class="heroMsg" id="firstMsg">‚Äú‚Ä¶‚Äù</p>
            <p class="heroSub">Tudo come√ßou em um superlike no Inner Circle.</p>
            <div class="row" style="margin-top:12px;">
              <button class="btn" id="enterStoryBtn">Entrar na nossa hist√≥ria</button>
            </div>
          </div>
        </div>

        <!-- PAGE 2+: o resto (come√ßa escondido) -->
        <div id="storyBlocks" class="hidden">

          <div class="card" id="sec-story">
            <h2>Linha do tempo</h2>
            <div class="timeline" id="timeline"></div>
          </div>

          <div class="card" id="sec-stats">
            <h2>N√∫meros que viram romance</h2>

            <div class="kpiRow" id="kpis">
              <div class="kpi"><div class="v">‚Äî</div><div class="l">Total de mensagens</div></div>
              <div class="kpi"><div class="v">‚Äî</div><div class="l">Total de dias conversando</div></div>
              <div class="kpi"><div class="v">‚Äî</div><div class="l">Hor√°rio favorito</div></div>
            </div>

            <div class="hr"></div>

            <h2 style="margin-top:0;">‚ÄúEu te amo‚Äù e varia√ß√µes</h2>
            <div class="muted">Quantas vezes cada um falou</div>
            <div class="barWrap" id="loveBars"></div>

            <div class="hr"></div>

            <!-- 3: Saudade detectada (n√£o fixo!) -->
            <div class="quoteBox" id="firstSaudadeBox">
              <div class="meta">Primeira ‚Äúsaudade‚Äù</div>
              <div>‚Äî</div>
            </div>

            <div class="quoteBox" id="firstVouSentirSaudadeBox">
              <div class="meta">Primeiro ‚Äúvou sentir saudades‚Äù</div>
              <div>‚Äî</div>
            </div>

            <div class="hr"></div>

            <div class="grid" style="gap:14px;">
              <div class="card span6" style="margin:0;">
                <h2>Top 10 palavras de carinho</h2>
                <div class="barWrap" id="topWords"></div>
              </div>

              <div class="card span6" style="margin:0;">
                <h2>O dia mais intenso</h2>
                <div class="muted" id="bestDayInfo">‚Äî</div>

                <div class="hr"></div>
                <div class="muted" style="margin-bottom:8px;">Top 5 dias com mais mensagens</div>
                <div class="barWrap" id="topDays"></div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid" style="gap:14px;">
              <div class="card span6" style="margin:0;">
                <h2>Emojis mais usados</h2>
                <div class="chips" id="emojiChips"></div>
              </div>

              <div class="card span6" style="margin:0;">
                <h2>Fotos enviadas</h2>
                <div class="kpiRow" id="photoKpis"></div>
              </div>
            </div>

          </div>

          <div class="card" id="sec-faith">
            <h2>Pequenas certezas</h2>
            <div class="quoteBox">
              ‚ÄúCarregue em seu cora√ß√£o a certeza de que sempre valer√° a pena esperar. O nosso tempo tem pressa, o tempo de Deus tem perfei√ß√£o.‚Äù
            </div>
            <div class="quoteBox">
              ‚ÄúDeus, que seus planos sejam melhores que o meu.‚Äù
            </div>
          </div>

          <div class="card" id="sec-question">
            <h2>Final</h2>
            <div class="heroBox pulse">
              <p class="heroMsg" style="margin:0 0 8px;">Tenho uma pergunta‚Ä¶</p>
              <p class="heroSub" style="margin:0 0 14px;">Respira. Sorri. E olha pra gente. üíó</p>
              <button class="btn" id="openQuestionBtn">Tenho uma pergunta‚Ä¶</button>
            </div>

            <div class="heroBox hidden" id="questionBox" style="margin-top:12px;">
              <p class="heroMsg" style="margin:0 0 8px;">Quer namorar comigo?</p>
              <div class="row" style="margin-top:10px;">
                <button class="btn" id="yesBtn">SIM üíç</button>
                <button class="btn" id="obviousBtn">√ìBVIO üò≠</button>
                <button class="btnGhost" id="noBtn">N√£o</button>
              </div>
              <div class="toast" id="noToast" style="display:none; margin-top:12px;">Tenta de novo üòÑ</div>
            </div>
          </div>

          <!-- PRESENTE (ajuste 7) -->
          <div class="card hidden" id="sec-gift">
            <h2>‚ú®</h2>
            <div class="heroBox">
              <p class="heartBig">‚ù§Ô∏è</p>
              <div class="lyrics">
A gente se escolhe todo dia 
                E eu te escolheria mais milh√µes de vidas 
                Porque uma s√≥ √© pouco com voc√™, amor 
                E eu quero tudo que eu puder viver com voc√™


                              </div>
            </div>

            <div class="row" style="margin-top:12px; justify-content:flex-end;">
              <button class="btnGhost" id="restartBtn2">‚ü≤ Recome√ßar</button>
            </div>
          </div>

        </div><!-- /storyBlocks -->
      </div><!-- /grid -->
    </main>
  </div><!-- /app -->

<script>
/*****************************************************************
 * CONFIG
 *****************************************************************/
const EXPECTED_PIN_NUMBERS = "0702"; // 07/02

// Arquivo do chat vem "embutido" via assets/chat/chat.js
// Precisa existir: window.__CHAT_TEXT__ = `...conte√∫do...`;
function getEmbeddedChatText(){
  if (typeof window.__CHAT_TEXT__ === "string" && window.__CHAT_TEXT__.trim()) {
    return window.__CHAT_TEXT__;
  }
  return null;
}

// Fotos (5 imagens: 01..05)
const PHOTO_NUMBERS = ["01","02","03","04","05"];
const PHOTO_EXTS = [".jpg",".jpeg",".png",".webp"];

// Textos do √°lbum
const ALBUM_TEXT = [
  { big:"A gente",        small:"Do jeitinho que Deus escreveu.", tag:"üíó" },
  { big:"Nossa hist√≥ria", small:"Feita de detalhes, risadas e cuidado.", tag:"‚ú®" },
  { big:"Eu + voc√™",      small:"E a certeza de que vale a pena.", tag:"ü§ç" },
  { big:"Caminho",        small:"Com calma, com verdade e f√©.", tag:"üåô" },
  { big:"Futuro",         small:"O melhor de Deus ainda est√° por vir.", tag:"üåπ" }
];

// Timeline fixa
const STORY = [
  { date:"29/12/2025", title:"Match", text:"Aquele superlike que virou destino. ‚ú®" },
  { date:"09/01/2026", title:"Primeiro encontro", text:"Quando o nervosismo virou sorriso f√°cil. ü•∞" },
  { date:"17/01/2026", title:"Segundo encontro", text:"A gente j√° parecia se conhecer h√° tempos. ü§ç" },
  { date:"20/01/2026", title:"Terceiro encontro", text:"Mais assunto, mais conex√£o, mais ‚Äòa gente‚Äô. üí¨" },
  { date:"24/01/2026", title:"Quarto encontro", text:"Ficou claro: vale a pena cuidar do que √© raro. üåπ" },
  { date:"25/01/2026", title:"Sexto encontro", text:"Nem tudo precisa de pressa ‚Äî s√≥ de verdade. üåô" },
  { date:"31/01/2026", title:"S√©timo encontro", text:"A paz de estar no lugar certo, com a pessoa certa. ‚ú®" },
  { date:"07/02/2026", title:"???", text:"Hoje eu vou te fazer uma pergunta‚Ä¶ ‚ùì‚ùì‚ùì" }
];

/*****************************************************************
 * Helpers de URL (fotos)
 *****************************************************************/
function absFromHere(relPath){
  return new URL(relPath, window.location.href).toString();
}
async function fetchOk(url){
  try{
    const res = await fetch(url, { cache:"no-store" });
    return res.ok;
  }catch(e){ return false; }
}
async function findFirstWorkingUrl(urls){
  for(const u of urls){
    if(await fetchOk(u)) return u;
  }
  return null;
}

/*****************************************************************
 * Album
 *****************************************************************/
const albumOverlay = document.getElementById("albumOverlay");
const pinOverlay   = document.getElementById("pinOverlay");

const albumImg = document.getElementById("albumImg");
const photoPlaceholder = document.getElementById("photoPlaceholder");
const albumBig = document.getElementById("albumBig");
const albumSmall = document.getElementById("albumSmall");
const albumTag = document.getElementById("albumTag");
const albumCount = document.getElementById("albumCount");

const dots = document.getElementById("dots");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const goPinFromAlbum = document.getElementById("goPinFromAlbum");

let albumIndex = 0;

function renderDots(){
  dots.innerHTML = "";
  for(let i=0;i<PHOTO_NUMBERS.length;i++){
    const d = document.createElement("div");
    d.className = "dot" + (i===albumIndex ? " active" : "");
    d.onclick = async ()=>{ albumIndex=i; await renderAlbum(); };
    dots.appendChild(d);
  }
}

async function renderAlbum(){
  const num = PHOTO_NUMBERS[albumIndex];
  const text = ALBUM_TEXT[albumIndex] || { big:"", small:"", tag:"üíó" };

  albumBig.textContent = text.big;
  albumSmall.textContent = text.small;
  albumTag.textContent = text.tag || "üíó";
  albumCount.textContent = `${albumIndex+1}/${PHOTO_NUMBERS.length}`;

  prevBtn.disabled = albumIndex === 0;
  renderDots();

  photoPlaceholder.classList.add("hidden");
  albumImg.removeAttribute("src");

  const candidates = [];
  for(const ext of PHOTO_EXTS){
    candidates.push(absFromHere(`./assets/photos/${num}${ext}`));
  }
  const okUrl = await findFirstWorkingUrl(candidates);

  if(okUrl){
    albumImg.src = okUrl;
  } else {
    photoPlaceholder.classList.remove("hidden");
  }
}

prevBtn.onclick = async ()=>{
  albumIndex = Math.max(0, albumIndex-1);
  await renderAlbum();
};
nextBtn.onclick = async ()=>{
  albumIndex = Math.min(PHOTO_NUMBERS.length-1, albumIndex+1);
  await renderAlbum();
};

goPinFromAlbum.onclick = ()=>{
  albumOverlay.classList.add("hidden");
  pinOverlay.classList.remove("hidden");
  document.getElementById("pin").focus();
};

// ‚úÖ sempre come√ßa no √°lbum
function hardStartInAlbum(){
  document.getElementById("app").classList.add("hidden");
  pinOverlay.classList.add("hidden");
  albumOverlay.classList.remove("hidden");
  window.scrollTo({ top:0, behavior:"instant" });
}
hardStartInAlbum();
renderAlbum();

/*****************************************************************
 * PIN
 *****************************************************************/
const pin = document.getElementById("pin");
const enterBtn = document.getElementById("enterBtn");
const toast = document.getElementById("toast");
const backToAlbum = document.getElementById("backToAlbum");

function normPinDigits(s){ return (s||"").replace(/\D/g,""); }

function openAlbum(){
  pinOverlay.classList.add("hidden");
  albumOverlay.classList.remove("hidden");
}
backToAlbum.onclick = openAlbum;

function tryEnter(){
  const digits = normPinDigits(pin.value);
  if(digits === EXPECTED_PIN_NUMBERS){
    toast.style.display = "none";
    pinOverlay.classList.add("hidden");
    albumOverlay.classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    // ‚úÖ mostra s√≥ ‚ÄúO come√ßo‚Äù
    document.getElementById("storyBlocks").classList.add("hidden");
    loadAndRender();
    window.scrollTo({ top:0, behavior:"instant" });
  } else {
    toast.style.display = "block";
    toast.textContent = "Data inv√°lida.";
  }
}
enterBtn.onclick = tryEnter;
pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryEnter(); });

/*****************************************************************
 * Restart
 *****************************************************************/
const restartBtn  = document.getElementById("restartBtn");
const restartBtn2 = document.getElementById("restartBtn2");

function fullRestart(){
  pin.value = "";
  toast.style.display = "none";
  hardStartInAlbum();
  albumIndex = 0;
  renderAlbum();
}
restartBtn.onclick = fullRestart;
restartBtn2.onclick = fullRestart;

/*****************************************************************
 * Timeline render
 *****************************************************************/
function renderTimeline(){
  const el = document.getElementById("timeline");
  el.innerHTML = "";
  STORY.forEach(item=>{
    const div = document.createElement("div");
    div.className = "tlItem";
    div.innerHTML = `
      <div class="tlDot"></div>
      <div>
        <p class="tlDate">${escapeHtml(item.date)} ‚Äî ${escapeHtml(item.title)}</p>
        <p class="tlText">${escapeHtml(item.text)}</p>
      </div>
    `;
    el.appendChild(div);
  });
}

/*****************************************************************
 * Load Chat (garantido)
 *****************************************************************/
const statusBadge = document.getElementById("statusBadge");

function loadAndRender(){
  statusBadge.textContent = "Carregando‚Ä¶";

  const text = getEmbeddedChatText();
  if(!text){
    statusBadge.textContent = "Chat n√£o carregou";
    // n√£o mostra ‚Äúfonte‚Äù nem overlay ‚Äî s√≥ falha clara
    document.getElementById("firstMsg").textContent = "‚ÄúN√£o encontrei o chat embutido (assets/chat/chat.js).‚Äù";
    return;
  }

  const messages = parseWhatsApp(text).filter(m => !isSystemMessage(m.text));
  if(!messages.length){
    statusBadge.textContent = "Sem dados";
    document.getElementById("firstMsg").textContent = "‚ÄúN√£o consegui ler mensagens no formato exportado.‚Äù";
    return;
  }

  statusBadge.textContent = "Pronto üíó";
  renderTimeline();
  renderAll(messages);
}

/*****************************************************************
 * Parser WhatsApp
 *****************************************************************/
const lineStartRe = /^\[(\d{2}\/\d{2}\/\d{4}),\s(\d{2}:\d{2}:\d{2})\]\s([^:]+):\s(.*)$/;

function parseWhatsApp(text){
  const lines = (text || "").replace(/\r\n/g, "\n").split("\n");
  const out = [];
  let cur = null;

  for(const raw of lines){
    const line = raw ?? "";
    const m = line.match(lineStartRe);
    if(m){
      if(cur) out.push(cur);
      const [_, dateStr, timeStr, author, msg] = m;
      cur = { dt: parseBRDateTime(dateStr, timeStr), author: author.trim(), text: (msg || "").trim() };
    } else {
      if(cur){
        cur.text += (cur.text ? "\n" : "") + line.trimEnd();
      }
    }
  }
  if(cur) out.push(cur);
  return out.filter(x => x.author && x.dt && typeof x.text === "string");
}

function parseBRDateTime(d, t){
  const [dd, mm, yyyy] = d.split("/").map(Number);
  const [HH, MM, SS] = t.split(":").map(Number);
  return new Date(yyyy, mm-1, dd, HH, MM, SS);
}

function isSystemMessage(text){
  const s = (text || "").toLowerCase();
  return (
    s.includes("criptografia de ponta a ponta") ||
    s.includes("mensagens e liga√ß√µes s√£o protegidas") ||
    s.includes("omitiu") ||
    s.includes("imagem omitida") ||
    s.includes("v√≠deo omitido") || s.includes("video omitido") ||
    s.includes("√°udio omitido") || s.includes("audio omitido") ||
    s.includes("figurinha omitida") ||
    s.includes("documento omitido") ||
    s.includes("localiza√ß√£o omitida") || s.includes("localizacao omitida") ||
    s.startsWith("‚Äé")
  );
}

/*****************************************************************
 * Detec√ß√µes: love / saudade
 *****************************************************************/
const lovePatterns = [
  /\beu\s*te\s*amo+\b/i,
  /\bte\s*amo+\b/i,
  /\bt\s*amo+\b/i,
  /\bamo\s*(voc√™|voce|vc|tu)\b/i,
  /\bte\s*adoro+\b/i,
  /\bsou\s*apaixonad[oa]\b/i
];

const saudadePatterns = [
  /\bt[o√¥]\s*com\s*saudade(s)?\b/i,
  /\bto\s*com\s*saudade(s)?\b/i,
  /\bestou\s*com\s*saudade(s)?\b/i,
  /\bsaudade(s)?\b/i
];

// espec√≠fico ‚Äúvou sentir saudades‚Äù
const vouSentirSaudadePatterns = [
  /\bvou\s*sentir\s*saudade(s)?\b/i,
  /\birei\s*sentir\s*saudade(s)?\b/i,
  /\bvou\s*ficar\s*com\s*saudade(s)?\b/i
];

function isLove(text){
  const s = (text || "").trim();
  return !!s && lovePatterns.some(re => re.test(s));
}
function isSaudade(text){
  const s = (text || "").trim();
  return !!s && saudadePatterns.some(re => re.test(s));
}
function isVouSentirSaudade(text){
  const s = (text || "").trim();
  return !!s && vouSentirSaudadePatterns.some(re => re.test(s));
}

/*****************************************************************
 * Emojis + fotos (omitidas)
 *****************************************************************/
const PHOTO_OMITTED_RE = /(imagem|foto|photo)\s*(ocultad|omitid)/i;

function isPhotoOmitted(text){
  return PHOTO_OMITTED_RE.test(text || "");
}

function extractEmojis(str){
  const s = String(str || "");
  // pega pictographs/emojis mais comuns
  const m = s.match(/[\p{Extended_Pictographic}]/gu);
  return m || [];
}

/*****************************************************************
 * Stopwords / top palavras de carinho
 *****************************************************************/
const STOP = new Set([
  "a","o","os","as","de","do","da","dos","das","e","√©","em","um","uma","pra","pro","por","na","no","nas","nos",
  "que","eu","vc","vcs","voc√™","voce","tu","me","te","se","n√£o","nao","sim","com","para","tb","tamb√©m","tambem",
  "t√°","ta","to","t√¥","tudo","bem","bom","boa","oi","ola","ol√°","kk","kkkk","haha","hahaha","pq","porque","q","d",
  "j√°","ja","mais","muito","muita","muitas","muitos","s√≥","so","vai","vou","foi","ser","tava","tive","tem","t√™m"
]);

const CARINHO_WHITELIST = new Set([
  "saudade","amor","vida","linda","lindo","princesa","nen√©m","nenem","bb","beb√™","bebe","gatinha","gatinho",
  "querida","querido","moz√£o","mozao","cora√ß√£o","coracao","beijo","beijinho","abra√ßo","abraco"
]);

/*****************************************************************
 * Render principal
 *****************************************************************/
function renderAll(messages){
  // 4) primeira mensagem QUE VOC√ä mandou (Matheus)
  const firstFromMatheus = messages.find(m => (m.author || "").toLowerCase().includes("matheus"));
  document.getElementById("firstMsg").textContent =
    firstFromMatheus ? `‚Äú${clip(firstFromMatheus.text, 120)}‚Äù` : "‚ÄúOi‚Ä¶‚Äù";

  // bot√£o -> revela resto
  document.getElementById("enterStoryBtn").onclick = ()=>{
    document.getElementById("storyBlocks").classList.remove("hidden");
    document.getElementById("sec-story").scrollIntoView({ behavior:"smooth", block:"start" });
  };

  // KPIs
  const totalMsgs = messages.length;
  const daysSet = new Set(messages.map(m => fmtDayKey(m.dt)));
  const totalDays = daysSet.size;

  const buckets = { "Madrugada (00-05)":0, "Manh√£ (06-11)":0, "Tarde (12-17)":0, "Noite (18-23)":0 };
  for(const m of messages){
    const h = m.dt.getHours();
    if(h <= 5) buckets["Madrugada (00-05)"]++;
    else if(h <= 11) buckets["Manh√£ (06-11)"]++;
    else if(h <= 17) buckets["Tarde (12-17)"]++;
    else buckets["Noite (18-23)"]++;
  }
  const favHour = Object.entries(buckets).sort((a,b)=>b[1]-a[1])[0]?.[0] || "‚Äî";

  const kpisEl = document.getElementById("kpis");
  kpisEl.innerHTML = "";
  kpisEl.appendChild(kpi(totalMsgs.toLocaleString("pt-BR"), "Total de mensagens"));
  kpisEl.appendChild(kpi(totalDays.toLocaleString("pt-BR"), "Total de dias conversando"));
  kpisEl.appendChild(kpi(favHour, "Hor√°rio favorito de conversa"));

  // Love bars
  const loveMsgs = messages.filter(m => isLove(m.text));
  const loveBy = countBy(loveMsgs, m => m.author);
  renderBars("loveBars", loveBy, true);

  // 3) Saudade detectada (primeira)
  const saudadeMsgs = messages.filter(m => isSaudade(m.text));
  const firstSaudade = saudadeMsgs.length ? saudadeMsgs.slice().sort((a,b)=>a.dt-b.dt)[0] : null;
  renderQuoteBox("firstSaudadeBox", firstSaudade, "N√£o encontrei ‚Äúsaudade‚Äù.");

  // 3) Vou sentir saudades (primeira)
  const vouMsgs = messages.filter(m => isVouSentirSaudade(m.text));
  const firstVou = vouMsgs.length ? vouMsgs.slice().sort((a,b)=>a.dt-b.dt)[0] : null;
  renderQuoteBox("firstVouSentirSaudadeBox", firstVou, "N√£o encontrei ‚Äúvou sentir saudades‚Äù.");

  // Top palavras
  const topWords = computeTopWords(messages);
  renderBarsFromEntries("topWords", topWords);

  // 5) Dia mais intenso + ranking top 5
  const byDay = countBy(messages, m => fmtDayKey(m.dt));
  const entriesDays = Object.entries(byDay).sort((a,b)=>b[1]-a[1]);
  const best = entriesDays[0];
  document.getElementById("bestDayInfo").textContent =
    best ? `${fmtDayKeyBR(best[0])} ‚Ä¢ ${best[1]} mensagens` : "‚Äî";

  const top5 = entriesDays.slice(0,5).map(([dayKey, count])=>({ label: fmtDayKeyBR(dayKey), count }));
  renderTopDays("topDays", top5);

  // 6) Emojis mais usados
  const emojiCounts = new Map();
  for(const m of messages){
    const ems = extractEmojis(m.text);
    for(const e of ems){
      emojiCounts.set(e, (emojiCounts.get(e)||0) + 1);
    }
  }
  const topEmojis = Array.from(emojiCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,12);
  renderEmojiChips("emojiChips", topEmojis);

  // 6) Fotos omitidas por autor
  const photoMsgs = messages.filter(m => isPhotoOmitted(m.text));
  const photoBy = countBy(photoMsgs, m => m.author);
  renderPhotoKpis("photoKpis", photoBy);

  // Pergunta final
  const openQuestionBtn = document.getElementById("openQuestionBtn");
  const questionBox = document.getElementById("questionBox");
  const noToast = document.getElementById("noToast");
  const secGift = document.getElementById("sec-gift");

  openQuestionBtn.onclick = ()=>{
    questionBox.classList.remove("hidden");
    questionBox.scrollIntoView({ behavior:"smooth", block:"center" });
  };

  function accepted(){
    secGift.classList.remove("hidden");
    secGift.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  document.getElementById("yesBtn").onclick = accepted;
  document.getElementById("obviousBtn").onclick = accepted;
  document.getElementById("noBtn").onclick = ()=>{
    noToast.style.display = "block";
    setTimeout(()=>{ noToast.style.display="none"; }, 1400);
  };
}

/*****************************************************************
 * Render helpers
 *****************************************************************/
function kpi(value, label){
  const div = document.createElement("div");
  div.className = "kpi";
  div.innerHTML = `<div class="v">${escapeHtml(value)}</div><div class="l">${escapeHtml(label)}</div>`;
  return div;
}

function renderBars(containerId, mapObj, isLove=false){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  const entries = Object.entries(mapObj).sort((a,b)=>b[1]-a[1]);
  if(!entries.length){
    el.innerHTML = `<div class="muted">${isLove ? "Nenhuma declara√ß√£o detectada ainda üòÖ" : "Sem dados"}</div>`;
    return;
  }
  const max = Math.max(...entries.map(e => e[1]));
  for(const [name, val] of entries){
    const row = document.createElement("div");
    row.className = "barRow";
    const pct = max ? Math.round((val/max)*100) : 0;
    row.innerHTML = `
      <div class="badge" title="${escapeHtml(name)}">${escapeHtml(shortName(name))}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="muted" style="text-align:right">${val.toLocaleString("pt-BR")}</div>
    `;
    el.appendChild(row);
  }
}

function renderBarsFromEntries(containerId, entries){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  if(!entries.length){
    el.innerHTML = `<div class="muted">Sem palavras detectadas.</div>`;
    return;
  }
  const max = Math.max(...entries.map(e => e.count));
  entries.forEach(({word, count})=>{
    const pct = max ? Math.round((count/max)*100) : 0;
    const row = document.createElement("div");
    row.className = "barRow";
    row.innerHTML = `
      <div class="badge">${escapeHtml(word)}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="muted" style="text-align:right">${count}</div>
    `;
    el.appendChild(row);
  });
}

function renderQuoteBox(boxId, msg, fallback){
  const box = document.getElementById(boxId);
  const meta = box.querySelector(".meta")?.textContent || "";
  if(!msg){
    box.innerHTML = `<div class="meta">${escapeHtml(meta)}</div><div>${escapeHtml(fallback)}</div>`;
    return;
  }
  box.innerHTML = `
    <div class="meta">${escapeHtml(msg.author)} ‚Ä¢ ${escapeHtml(fmtDT(msg.dt))}</div>
    <div>${escapeHtml(msg.text).replace(/\n/g,"<br>")}</div>
  `;
}

function renderTopDays(containerId, topDays){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  if(!topDays.length){
    el.innerHTML = `<div class="muted">‚Äî</div>`;
    return;
  }
  const max = Math.max(...topDays.map(x=>x.count));
  for(const d of topDays){
    const pct = max ? Math.round((d.count/max)*100) : 0;
    const row = document.createElement("div");
    row.className = "barRow";
    row.innerHTML = `
      <div class="badge" title="${escapeHtml(d.label)}">${escapeHtml(d.label)}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="muted" style="text-align:right">${d.count}</div>
    `;
    el.appendChild(row);
  }
}

function renderEmojiChips(containerId, entries){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  if(!entries.length){
    el.innerHTML = `<div class="muted">Sem emojis detectados.</div>`;
    return;
  }
  for(const [emoji, count] of entries){
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerHTML = `<span style="font-size:18px">${escapeHtml(emoji)}</span> <small>${count}</small>`;
    el.appendChild(chip);
  }
}

function renderPhotoKpis(containerId, mapObj){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  const entries = Object.entries(mapObj).sort((a,b)=>b[1]-a[1]);
  if(!entries.length){
    el.innerHTML = `<div class="muted">Sem fotos detectadas no export.</div>`;
    return;
  }
  for(const [name, val] of entries){
    el.appendChild(kpi(val.toLocaleString("pt-BR"), `Fotos (ocultadas) ‚Ä¢ ${shortName(name)}`));
  }
}

/*****************************************************************
 * Top words
 *****************************************************************/
function computeTopWords(messages){
  const counts = new Map();

  for(const m of messages){
    const text = (m.text || "")
      .toLowerCase()
      .replace(/[^\p{L}\p{N}\s]/gu, " ")
      .replace(/\s+/g, " ")
      .trim();

    if(!text) continue;

    const words = text.split(" ").filter(Boolean);
    for(const w0 of words){
      const w = w0.normalize("NFD").replace(/\p{Diacritic}/gu,"");
      if(w.length < 3) continue;
      if(STOP.has(w)) continue;
      counts.set(w, (counts.get(w) || 0) + 1);
    }
  }

  const arr = Array.from(counts.entries()).map(([word,count])=>({word,count}));
  arr.sort((a,b)=> b.count - a.count);

  const carinhoFirst = arr.filter(x => CARINHO_WHITELIST.has(x.word));
  const others = arr.filter(x => !CARINHO_WHITELIST.has(x.word));

  return [...carinhoFirst, ...others].slice(0,10);
}

/*****************************************************************
 * Util
 *****************************************************************/
function countBy(arr, fn){
  const out = {};
  for(const x of arr){
    const k = fn(x);
    out[k] = (out[k] || 0) + 1;
  }
  return out;
}
function fmtDayKey(dt){
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function fmtDayKeyBR(dayKey){
  const [y,m,d] = dayKey.split("-");
  return `${d}/${m}/${y}`;
}
function fmtDT(dt){
  const d = String(dt.getDate()).padStart(2,"0");
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const y = dt.getFullYear();
  const hh = String(dt.getHours()).padStart(2,"0");
  const mm = String(dt.getMinutes()).padStart(2,"0");
  return `${d}/${m}/${y} ${hh}:${mm}`;
}
function shortName(name){
  const parts = (name || "").trim().split(/\s+/).filter(Boolean);
  if(parts.length <= 1) return name || "";
  return `${parts[0]} ${parts[parts.length-1][0]}.`;
}
function clip(s, n){
  const t = String(s || "").replace(/\s+/g," ").trim();
  if(t.length <= n) return t;
  return t.slice(0, n-1) + "‚Ä¶";
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
